
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>vimtaku blog</title>
	<meta name="author" content="vimtaku">

	
	<meta name="description" content="概要
日経Linux 2月号(2014)
に、カーネルの特集記事があったので買って読んでみた。
今まで知らなかった部分とか、便利そうなことについて、以下に記載する。 メモリ管理
buddy システム, スラブアロケータについて書かれていた。 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="vimtaku blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="http://vimtakublog.qolwu.com/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">vimtaku blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:vimtaku.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/vimtaku" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/vimtaku" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:vimtaku.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/nikkei-linux-feb/">
		
			日経Linux 2月号を読んだ</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">概要</h2>
<p><a href="http://www.amazon.co.jp/%E6%97%A5%E7%B5%8C-Linux-%E3%83%AA%E3%83%8A%E3%83%83%E3%82%AF%E3%82%B9-2014%E5%B9%B4-02%E6%9C%88%E5%8F%B7/dp/B00H8X84E6">日経Linux 2月号(2014)</a>
に、カーネルの特集記事があったので買って読んでみた。<br />
今まで知らなかった部分とか、便利そうなことについて、以下に記載する。  </p>

<h2 id="section-1">メモリ管理</h2>
<p>buddy システム, スラブアロケータについて書かれていた。<br />
この本よりもっと詳しく書かれたページを発見したのでコチラを参照。<br />
<a href="http://www.coins.tsukuba.ac.jp/~yas/coins/os2-2011/2012-01-17/">http://www.coins.tsukuba.ac.jp/~yas/coins/os2-2011/2012-01-17/</a></p>

<h2 id="systemtap">systemtap</h2>
<p>system tap とは <a href="https://access.redhat.com/site/ja/node/289453">https://access.redhat.com/site/ja/node/289453</a> にある通り  </p>

<blockquote><p>実行している Linux カーネルで簡易情報を取得できるようにする革新的なツールです。</p></blockquote>
<p>である。  </p>

<h3 id="install-centos">install 方法(@CentOS)</h3>
<p>vagrant で建てた CentOS を使ってやってみる。<br />
Vagrantfile 的に<br />
config.vm.box = “Berkshelf-CentOS-6.3-x86_64-minimal”<br />
この box を使っている人は以下の通りでインストールできると思います。  </p>

<div>
  <pre><code class="bash">sudo yum -y install systemtap
cd /tmp
wget http://debuginfo.centos.org/6/x86_64/kernel-debuginfo-common-x86_64-2.6.32-279.el6.x86_64.rpm
wget http://debuginfo.centos.org/6/x86_64/kernel-debug-debuginfo-2.6.32-279.el6.x86_64.rpm
sudo yum install kernel-debuginfo-common-x86_64-2.6.32-279.el6.x86_64.rpm
sudo yum install kernel-debug-debuginfo-2.6.32-279.el6.x86_64.rpm

# これで stap がつかえる
stap

## 追記
(これだと probe.kernel が使えないっぽい.. 要調査。)</code></pre>
</div>

<p>あとは
<a href="http://sourceware.org/systemtap/examples/">http://sourceware.org/systemtap/examples/</a><br />
ここから<br />
vm.tracepoints.stp や, sched_switch.stp を落として来て実行できる。  </p>

<p>(参考)<br />
<a href="http://stts.hatenablog.com/entry/20090614/1244952417">http://stts.hatenablog.com/entry/20090614/1244952417</a>  </p>

<h2 id="section-2">プロセスのメモリ割付について</h2>
<p>/proc/[processId]/maps (これをメモリーマップと呼ぶ。)を参照すれば、どのようにメモリが割り付けられているかがわかる。  </p>

<div>
  <pre><code class="bash">vi hoge.c
-----
#include &lt;stdio.h&gt;

int main(void) {
  char hoge[4096] = &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;;

printf(&quot;sleep start\n&quot;);
  sleep(500000);
printf(&quot;sleep stop\n&quot;);
  return 0;
}

ps aux | grep a.out
vagrant  19157  0.0  0.0   3928   408 pts/1    S+   04:41   0:00 ./a.out
vagrant  19164  0.0  0.0 107456   948 pts/0    S+   04:42   0:00 grep a.out


cd /proc/
cat /proc/19157/maps

00400000-00402000 r-xp 00000000 fd:00 3590                               /tmp/a.out
00601000-00602000 rw-p 00001000 fd:00 3590                               /tmp/a.out
7fdf912e5000-7fdf91470000 r-xp 00000000 fd:00 3071                       /lib64/libc-2.12.so
7fdf91470000-7fdf9166f000 ---p 0018b000 fd:00 3071                       /lib64/libc-2.12.so
7fdf9166f000-7fdf91673000 r--p 0018a000 fd:00 3071                       /lib64/libc-2.12.so
7fdf91673000-7fdf91674000 rw-p 0018e000 fd:00 3071                       /lib64/libc-2.12.so
7fdf91674000-7fdf91679000 rw-p 00000000 00:00 0
7fdf91679000-7fdf91699000 r-xp 00000000 fd:00 3437                       /lib64/ld-2.12.so
7fdf9188e000-7fdf91891000 rw-p 00000000 00:00 0
7fdf91896000-7fdf91898000 rw-p 00000000 00:00 0
7fdf91898000-7fdf91899000 r--p 0001f000 fd:00 3437                       /lib64/ld-2.12.so
7fdf91899000-7fdf9189a000 rw-p 00020000 fd:00 3437                       /lib64/ld-2.12.so
7fdf9189a000-7fdf9189b000 rw-p 00000000 00:00 0
7fff2a0dc000-7fff2a0f1000 rw-p 00000000 00:00 0                          [stack]
7fff2a1b4000-7fff2a1b5000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</code></pre>
</div>

<p>下から見ると、 systemcall が呼ばれる領域(カーネル仮想空間)があるのと、 stack が積まれる領域があるのと、<br />
shared object がリンクされている領域と、 テキスト(プログラム)が格納されている領域があるのが見て取れる。  </p>

<p>左端から、仮想アドレス、アクセス属性、データオフセット、 デバイスのメジャー番号とマイナー番号、 inode, ファイル名とのこと。  </p>

<h2 id="section-3">カーネル時計</h2>
<p>Linux カーネルは 起動時には、PC の内蔵時計を使用するが、それ移行は独自のカーネル時計を使用する。<br />
ミリ秒からナノ秒の処理が必要であるため。  </p>

<h2 id="io">I/Oスケジューラー</h2>
<p>入出力するブロックデータを並び替えて入出力を高速化できるもの。  </p>

<p><a href="http://city.hokkai.or.jp/~hachikun/IOScheduler.html">http://city.hokkai.or.jp/~hachikun/IOScheduler.html</a><br />
<a href="[http://city.hokkai.or.jp/~hachikun/IOScheduler.html]">http://www.valinux.co.jp/technologylibrary/document/linuxkarnel/cfq0001/</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kernel/'>kernel</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/mysql-workbench-rails/">
		
			MySQL Workbench で Rails の Migration ファイルを吐き出す</a>
	</h2>
	<div class="entry-content">
		<h2 id="toc">TOC</h2>
<ul id="markdown-toc">
  <li><a href="#toc">TOC</a></li>
  <li><a href="#section">概要</a></li>
  <li><a href="#mysql-workbench--ss">Mysql workbench の SS</a></li>
  <li><a href="#section-1">手順</a>    <ul>
      <li><a href="#mysql-workbench-rails-exporter-plugin-">1. mysql workbench rails exporter plugin をダウンロード</a></li>
      <li><a href="#mysql-workbench-">2. mysql workbench のインストール</a></li>
      <li><a href="#section-2">3. プラグインのインストールと実行</a></li>
    </ul>
  </li>
  <li><a href="#section-3">所感</a></li>
</ul>

<h2 id="section">概要</h2>
<p>mysql workbench っていう MySQL のER図を作るみたいなツールがある。<br />
CUI硬派のため、いままでは使ったことなかったけど、<br />
今回はじめて使ってみると結構いい感じだった。<br />
それを rails のマイグレーションファイルに吐き出したいなぁと思っていたら、<br />
それっぽいプラグインを見つけたので、その方法を書いておく。  </p>

<h2 id="mysql-workbench--ss">Mysql workbench の SS</h2>
<p><img src="http://gyazo.com/f15f8824bbfdd3bb3dccd514b697f5e5.png" /></p>

<h2 id="section-1">手順</h2>

<h3 id="mysql-workbench-rails-exporter-plugin-">1. mysql workbench rails exporter plugin をダウンロード</h3>
<p><a href="http://sourceforge.net/projects/railsexporter/">http://sourceforge.net/projects/railsexporter/</a>
ここから、 rails exporter を落としてくる。  </p>

<h3 id="mysql-workbench-">2. mysql workbench のインストール</h3>
<p>新しい workbench ツールに、上記プラグインが対応していなかったので、 ちょっと古いやつで試したら動作した。<br />
<a href="http://dev.mysql.com/downloads/tools/workbench/">http://dev.mysql.com/downloads/tools/workbench/</a> から、
Looking for previous GA versions? をたどると、 mysql-workbench-gpl-5.2.47-osx-i686.dmg  が落とせる。<br />
これをインストールする。  </p>

<h3 id="section-2">3. プラグインのインストールと実行</h3>
<p>mysql workbench のタブから、 “SCRIPTING &gt; INSTALL PLUGIN/MODULE …” で、展開した 1 の zip の .lua ファイルを選択する。<br />
mysql workbench を再起動して、 “PLUGINS &gt; CATALOG &gt; Rails Exporter 1.0.1” を選択すれば、あら不思議、<br />
$HOME に Rails_Explorer ディレクトリが。<br />
db と model が出来上がるので、あとはそれをよしなに利用すれば良い。  </p>

<h2 id="section-3">所感</h2>
<p>実際、このあとに、 mysql に接続して、ER図を吐き出すやつやってみたけど、<br />
まぁ当然、テーブル的にリレーションしてないわけだから、ER図もリレーションしてなくて、見づらい。<br />
raisl には ERD 生成ツールみたいなのがあるらしいので、<br />
最初の一回くらいしか使えないかもしれないけど、ないよりはいいかなぁ。<br />
ちなみに出来上がるファイルは若干修正が必要だと思う。<br />
ちゃんと mwb のほうで書いていれば大丈夫かもだけど。。<br />
mwb の方で、カラムに複数行のコメントを入れておくと、出力された時にダメなので、<br />
コメントを1行にするか、複数行の場合は先頭に#を入れると良いかもしれない。<br />
あと、 unsigned int を作りたいけど、うまいことやってくれなくて、<br />
gem “activerecord-mysql-unsigned”, “~&gt; 0.0.1”
これを入れて、手動で integer のカラムに :unsgined =&gt; true した。  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/life-feb-16/">
		
			2/16</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">先週振り返り</h2>
<p>先週も solr 力をかなり高める感じだった。<br />
docker がリアルに流行り始めているので、本格的に勉強したいところ。<br />
でも家のネットワークが遅くてちょっと厳しいんだよなぁ。<br />
なんかお腹の調子がずっと悪くてしんどかった。<br />
あと、雪の日に自宅待機したら迷惑かけてしまったので、今後は極力休まない。  </p>

<p>あんまり本が読めなかったので、気合入れて読む。<br />
あと、どうでもいいけど、 MBA の容量が 128GB で 94% とか言ってて積んでる感ある。  </p>

<h2 id="section-1">土日振り返り</h2>
<p>あんまり多く時間を取れなかったが、日経 linux 読んだのと、workbench の件をそこそこやった。  </p>

<h2 id="section-2">勉強途中経過</h2>

<h3 id="section-3">進んでない</h3>
<ul>
  <li>rails tutorial 6 までやった</li>
</ul>

<h2 id="section-4">読書途中経過</h2>

<h3 id="section-5">進んだ</h3>
<ul>
  <li>詳解UNIXプログラミング第8章まで読んだ</li>
</ul>

<h3 id="section-6">積んでる</h3>
<ul>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>ネットワークはなぜつながるのか?</li>
  <li>chef-solo 入門 #23 まで読んだ(どっかで手を動かしながらやる)</li>
  <li>パーフェクトルビー15章まで読んだ
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
  <li>論語入門</li>
</ul>

<h3 id="section-7">読み終えた</h3>
<ul>
  <li>(2014/2/16)(さらっと)日経Linux 2月号</li>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/octopress/">
		
			Jekyll から Octopress に10 分で移行する</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">背景</h2>
<p>デザインが見づらいって言われたので辛くなったから、<br />
octopress にノリで移行してみた。<br />
当方、 jekyll-bootstrap を使っていて、 octopress も普通に jekyll 使っているので<br />
問題なく移行できると思ったら移行できた。  </p>

<h2 id="section-1">手順</h2>
<p>大体こんなかんじでいける。空気さえ読めれば行ける感じ。  </p>

<div>
  <pre><code class="bash">git clone git://github.com/imathis/octopress.git octopress
cd octopress/
bundle install
rake install
rake preview
rake -T
vim config.rb
rake preview
rake setup_github_pages

## Rakefile の L269 の git push を -f するようにした。すでにレポジトリがあったから。
vim Rakefile

rake deploy

cp -a $HOME/jekyll-bootstrap/_posts/* .

## JB setup を記事に埋め込んでいるのがあったのでそれをケア(互換性のため)
mkdir $HOME/octopress/source/includes/JB
cp -a $HOME/jekyll-bootstrap/_includes/JB/setup $HOME/octopress/source/includes/JB</code></pre>
</div>

<h2 id="section-2">ちなみに</h2>
<p>テーマはコチラを使わせてもらった。<br />
<a href="http://zespia.tw/Octopress-Theme-Slash/">http://zespia.tw/Octopress-Theme-Slash/</a><br />
how to install 通りにやれば適用できる。  </p>

<p>Octopress テーマ集みたいなのはコチラ。<br />
<a href="http://opthemes.com/">http://opthemes.com/</a>  </p>

<h2 id="section-3">参考資料</h2>

<p><a href="http://joelmccracken.github.io/entries/octopress-is-pretty-sweet/">http://joelmccracken.github.io/entries/octopress-is-pretty-sweet/</a></p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/octopress/'>octopress</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/13/solr-sample/">
		
			今更 Solr 入門</a>
	</h2>
	<div class="entry-content">
		
<h2 id="toc">TOC</h2>
<ul id="markdown-toc">
  <li><a href="#toc">TOC</a></li>
  <li><a href="#section">この記事について</a></li>
  <li><a href="#section-1">予備知識</a>    <ul>
      <li><a href="#apache-solr-">Apache Solr とは</a></li>
      <li><a href="#lucene-">Lucene とは</a></li>
    </ul>
  </li>
  <li><a href="#section-2">スキーマを作ってみよう</a>    <ul>
      <li><a href="#section-3">フィールドタイプについて</a></li>
      <li><a href="#section-4">フィールドについて</a>        <ul>
          <li><a href="#section-5">テキストフィールドの定義</a></li>
          <li><a href="#section-6">ダイナミックフィールド</a></li>
          <li><a href="#section-7">ユニークキーフィールド</a></li>
          <li><a href="#section-8">コピーフィールド</a></li>
        </ul>
      </li>
      <li><a href="#core-admin--core-">core admin で core を作成</a></li>
    </ul>
  </li>
  <li><a href="#section-9">サンプルデータを入れてみよう</a></li>
  <li><a href="#dihdataimporthandler-">DIH(DataImportHandler) について</a>    <ul>
      <li><a href="#solr-config-">solr config に記述する</a></li>
      <li><a href="#mysql--connector-">mysql の connector をダウンロードして設置</a></li>
      <li><a href="#mysql--db-data-configxml-">mysql の設定, db-data-config.xml の設定など</a></li>
    </ul>
  </li>
  <li><a href="#deltaquery-">deltaQuery について</a>    <ul>
      <li><a href="#deltaquery--parentdeltaquery-">deltaQuery と parentDeltaQuery の関係</a></li>
    </ul>
  </li>
  <li><a href="#deletedpkquery-">(2014/5/12追記) deletedPkQuery について</a></li>
  <li><a href="#timezone-">(2014/5/12追記) Timezone の扱い</a></li>
  <li><a href="#dih--javascript-">DIH の直前で Javascript でデータを加工する</a>    <ul>
      <li><a href="#updatehandler--updatechain">UpdateHandler と UpdateChain</a></li>
      <li><a href="#section-10">なんかうまくいかない場合</a></li>
    </ul>
  </li>
  <li><a href="#url">参考URL</a></li>
</ul>

<h2 id="section">この記事について</h2>
<p>今更ながら Solr に興味が出てきたので、自分用にまとめてみる。<br />
あくまで自分用なので、ある程度わかっている人じゃないと本記事は無意味です。恐縮ながら。<br />
前提として、 この記事は <a href="http://www.amazon.co.jp/Apache-Solr%E5%85%A5%E9%96%80-~%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3-Software-Design/dp/4774161632">改訂新版 Apache Solr入門 ~オープンソース全文検索エンジン</a> を読みながら進めた。   </p>

<p>まずは、予備知識として Apache Solr とはなにか、 Lucene とはなにかについて書く。<br />
次に、スキーマを作って、サンプルデータ を 手動でのデータインポートで index に登録する手順について書く。<br />
手動でのデータインポートは大変なので、mysql からデータをインポートするクローラ(DIH)について書く。
最後に、 MySQL にある json を保存するカラムのデータを、 Javascript を使って整形し、 index に保存することについて書く。  </p>

<h2 id="section-1">予備知識</h2>

<h3 id="apache-solr-">Apache Solr とは</h3>
<p>全文検索システムである。<br />
全文検索エンジン Lucene をベースに、管理画面やキャッシュ、クラスタリングなどの機能がある。<br />
ちなみに Java で書かれている。<br />
<a href="http://ja.wikipedia.org/wiki/Apache_Solr">http://ja.wikipedia.org/wiki/Apache_Solr</a></p>

<h3 id="lucene-">Lucene とは</h3>
<blockquote><p>Lucene（ルシーン）は、Javaで記述された全文検索ソフトウェアである。<br />あらかじめ蓄積した大量のデータから、指定したキーワードを探し出す機能を持つ。Javaのクラスライブラリとして提供される。</p></blockquote>
<p><a href="http://ja.wikipedia.org/wiki/Lucene">http://ja.wikipedia.org/wiki/Lucene</a>
なるほど。</p>

<h2 id="section-2">スキーマを作ってみよう</h2>
<p>スキーマを作って、サンプルデータを入れてみる。<br />
ここでは、 料理人が複数いて、自分の料理をうるみたいなものを想定する。<br />
Solr の schema.xml で、スキーマを定義することができる。  </p>

<p>以下に、 schema.xml の fileds の設定例を載せる。  </p>
<div>
  <pre><code class="xml">&lt;fields&gt;
    &lt;field name=&quot;recipe_id&quot;   type=&quot;int&quot;     indexed=&quot;true&quot; stored=&quot;true&quot; required=&quot;true&quot;/&gt;
    &lt;field name=&quot;chef&quot;        type=&quot;text_ja&quot; indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
    &lt;field name=&quot;recipe_name&quot; type=&quot;text_ja&quot; indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
    &lt;field name=&quot;genre&quot;       type=&quot;text_ja&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot;/&gt;
    &lt;field name=&quot;price&quot;       type=&quot;int&quot;     indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
    &lt;field name=&quot;_version_&quot;   type=&quot;long&quot;    indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
  &lt;/fields&gt;</code></pre>
</div>

<h3 id="section-3">フィールドタイプについて</h3>
<ul>
  <li>fieldType は自分で xml を用いて定義することができる</li>
  <li>それらの名前付けとかには習慣がある</li>
  <li>基本的な型については定義されているので、それを利用する</li>
</ul>

<h3 id="section-4">フィールドについて</h3>

<h4 id="section-5">テキストフィールドの定義</h4>
<ul>
  <li>name は filed 名</li>
  <li>type は filedType</li>
  <li>indexed は、 このフィールドを検索対象、ソート対象、 ファセット対象にするか(true:する)</li>
  <li>stored は、 このフィールドの値をそのまま index するか(true:する)</li>
  <li>required は、 必須かどうか</li>
  <li>multivalued は、 複数値を持てるかどうか</li>
  <li>omitNorms は、 検索したドキュメントの長さによる重み付け
    <ul>
      <li>(短ければ当然、見つけるものに近いのでポイントが高く、逆に長ければ、それにヒットする確率が高いので値は低い。)</li>
    </ul>
  </li>
</ul>

<h4 id="section-6">ダイナミックフィールド</h4>
<ul>
  <li>動的にフィールド名が決定するもの</li>
  <li>schema.xml を変更しなくても、そのフィールド名を登録したり検索したりすることができるようになる</li>
</ul>

<h4 id="section-7">ユニークキーフィールド</h4>
<ul>
  <li>文書内で unique に特定できるようにするフィールド</li>
  <li>差分更新したい場合には必須</li>
  <li>指定はオプション</li>
  <li>
    <uniquekey>url</uniquekey>
  </li>
</ul>

<h4 id="section-8">コピーフィールド</h4>
<ul>
  <li>ドキュメントへのインデックス登録時に copyField の source から dest へコピーする</li>
  <li>dest に同じものを複数指定する場合は multiValued が true である必要がある</li>
</ul>

<h3 id="core-admin--core-">core admin で core を作成</h3>
<p>collection1 をコピーして, schema.xml を編集。<br />
elevate が評価されてダメっぽかったのでコメントアウト。<br />
すると、うまく load できた。</p>

<h2 id="section-9">サンプルデータを入れてみよう</h2>
<p>だいたいこんなかんじの data.json を用意して</p>
<div>
  <pre><code class="json">[                                                                              
{                                                                              
    &quot;recipe_id&quot;:&quot;1&quot;,                                                           
    &quot;chef&quot;:&quot;vimtaku&quot;,                                                          
    &quot;recipe_name&quot;:&quot;vim の炒めもの&quot;,                                            
    &quot;genre&quot;:[&quot;和食&quot;, &quot;洋食&quot;],                                                  
    &quot;price&quot;:980                                                                
},                                                                             
{                                                                              
    &quot;recipe_id&quot;:&quot;2&quot;,                                                           
    &quot;chef&quot;:&quot;noro&quot;,                                                             
    &quot;recipe_name&quot;:&quot;emacs 焼き&quot;,                                                
    &quot;genre&quot;:[&quot;和食&quot;, &quot;中華&quot;],                                                  
    &quot;price&quot;:500                                                                
},                                                                             
{                                                                              
    &quot;recipe_id&quot;:&quot;3&quot;,                                                           
    &quot;chef&quot;:&quot;sublime&quot;,                                                          
    &quot;recipe_name&quot;:&quot;sublime 揚げ&quot;,                                              
    &quot;genre&quot;:[&quot;洋食&quot;],                                                          
    &quot;price&quot;:250                                                                
}                                                                              
]</code></pre>
</div>

<div>
  <pre><code class="bash">curl &#39;http://localhost:8983/solr/vimtaku/update/json?commit=true&#39; --data-binary @data.json -H &#39;Content-type:application/json;charset:utf-8&#39;</code></pre>
</div>

<p>これで データ登録が完了する。  </p>

<h2 id="dihdataimporthandler-">DIH(DataImportHandler) について</h2>
<p>DIH は DataSource, EntityProccssor, そして設定ファイル(data‐config.xml) から成る。<br />
DIH を使うための設定は、 solrconfig.xml と DIHの設定ファイル data―config にある。  </p>

<h3 id="solr-config-">solr config に記述する</h3>
<div>
  <pre><code class="xml">&lt;requestHandler name=&quot;/dataimport&quot; class=&quot;org.apache.solr.handler.dataimport.DatalmportHandler&quot;&gt;
&lt;lst name=&quot;defaults&quot;&gt;
  &lt;str name=&quot;config&quot;&gt;db-data-config.xml&lt;/str&gt;
&lt;/lst&gt;
&lt;/requestHandler&gt;</code></pre>
</div>

<h3 id="mysql--connector-">mysql の connector をダウンロードして設置</h3>
<p>mysql-connector-java-5.1.29-bin.jar を <a href="http://dev.mysql.com/downloads/connector/j/">http://dev.mysql.com/downloads/connector/j/</a>から落としてきて
dist 以下に設置する。</p>

<h3 id="mysql--db-data-configxml-">mysql の設定, db-data-config.xml の設定など</h3>
<p>そしてだいたいこんなかんじに設置する。 mysql は localhost の 3306 番で動いているものとし、<br />
solrsample っていう database があるものとする。 password は hogehoge とする。  </p>

<div>
  <pre><code class="bash">diff --git a/conf/db-data-config.xml b/conf/db-data-config.xml
new file mode 100644
index 0000000..c758319
--- /dev/null
+++ b/conf/db-data-config.xml
@@ -0,0 +1,24 @@
+&lt;dataConfig&gt;
+    &lt;dataSource type=&quot;JdbcDataSource&quot; driver=&quot;com.mysql.jdbc.Driver&quot;
+        url=&quot;jdbc:mysql://localhost:3306/solrsample&quot;
+        user=&quot;vimtaku&quot; password=&quot;hogehoge&quot;/&gt;
+    &lt;document&gt;
+        &lt;entity name=&quot;recipe_mst&quot; pk=&quot;recipe_id&quot;
+            query=&quot;select * from recipe_mst&quot;
+            deltaImportQuery=&quot;SELECT * FROM recipe_mst WHERE recipe_id = ${dataimporter.delta.recipe_id}&quot;
+            deltaQuery=&quot;select recipe_id from recipe_mst WHERE updated_at &gt;= &#39;${dataimporter.last_index_time}&#39;&quot;&gt;
+            &lt;field column=&quot;recipe_id&quot; name=&quot;recipe_id&quot; /&gt;
+            &lt;field column=&quot;recipe_name&quot; name=&quot;recipe_name&quot; /&gt;
+            &lt;field column=&quot;price&quot; name=&quot;price&quot; /&gt;
+            &lt;entity name=&quot;recipe_genre_rel&quot;
+                query=&quot;select * from recipe_genre_rel where recipe_id = &#39;${recipe_mst.recipe_id}&#39;&quot;&gt;
+                &lt;entity name=&quot;genre_mst&quot; query=&quot;select * from genre_mst where genre_id = &#39;${recipe_genre_rel.genre_id}&#39;&quot;&gt;
+                    &lt;field column=&quot;name&quot; name=&quot;genre&quot; /&gt;
+                &lt;/entity&gt;
+            &lt;/entity&gt;
+            &lt;entity name=&quot;chef_mst&quot; query=&quot;select * from chef_mst where chef_id = &#39;${recipe_mst.chef_id}&#39;&quot;&gt;
+                &lt;field column=&quot;name&quot; name=&quot;chef&quot; /&gt;
+            &lt;/entity&gt;
+        &lt;/entity&gt;
+    &lt;/document&gt;
+&lt;/dataConfig&gt;
diff --git a/conf/solrconfig.xml b/conf/solrconfig.xml
index 00b7555..2d19133 100644
--- a/conf/solrconfig.xml
+++ b/conf/solrconfig.xml
@@ -84,6 +84,9 @@
   &lt;lib dir=&quot;../../../contrib/velocity/lib&quot; regex=&quot;.*\.jar&quot; /&gt;
   &lt;lib dir=&quot;../../../dist/&quot; regex=&quot;solr-velocity-\d.*\.jar&quot; /&gt;

+  &lt;lib dir=&quot;../../../dist/&quot; regex=&quot;solr-dataimporthandler-.*\.jar&quot; /&gt;
+  &lt;lib dir=&quot;../../../dist/&quot; regex=&quot;mysql.*\.jar&quot; /&gt;
+
   &lt;!-- an exact &#39;path&#39; can be used instead of a &#39;dir&#39; to specify a
        specific jar file.  This will cause a serious error to be logged
        if it can&#39;t be loaded.
@@ -1513,6 +1516,15 @@
   &lt;/requestHandler&gt;


+  &lt;requestHandler name=&quot;/dataimport&quot;
+      class=&quot;org.apache.solr.handler.dataimport.DataImportHandler&quot;&gt;
+      &lt;lst name=&quot;defaults&quot;&gt;
+          &lt;str name=&quot;config&quot;&gt;db-data-config.xml&lt;/str&gt;</code></pre>
</div>

<p>だいたいこんなかんじで、管理画面から /dataimport で full-import するといける。</p>

<h2 id="deltaquery-">deltaQuery について</h2>
<p>差分 update(delta-import) のとき、deltaQuery がまず、実行される。
deltaQuery は どんなに nest が深くても実行される(たぶん)。</p>

<h3 id="deltaquery--parentdeltaquery-">deltaQuery と parentDeltaQuery の関係</h3>
<ul>
  <li>deltaQuery で mysql のレコードがヒットした場合に、 parentDeltaQuery が呼び出される</li>
  <li>parentDeltaQuery では ${chef_mst.chef_id} のように、 deltaQuery でヒットしたものが使える</li>
  <li>parentDeltaQuery で、 pk の 値を select するようにしておく。</li>
  <li>pk のある entity に、
    <ul>
      <li>deltaImportQuery 属性がなくて query 属性がある場合には where pk = ‘’ としてクエリが実行され再登録される模様</li>
      <li>deltaImportQuery 属性がある場合にはそのクエリが実行される。</li>
    </ul>
  </li>
</ul>

<p>例えば</p>

<div>
  <pre><code class="xml">&lt;dataConfig&gt;
    &lt;dataSource type=&quot;JdbcDataSource&quot; driver=&quot;com.mysql.jdbc.Driver&quot;
        url=&quot;jdbc:mysql://localhost:3306/solrsample&quot;
        user=&quot;vimtaku&quot; password=&quot;hogehoge&quot;/&gt;
    &lt;document&gt;
        &lt;entity name=&quot;recipe_mst&quot; pk=&quot;recipe_id&quot;
            query=&quot;select * from recipe_mst&quot;
            deltaImportQuery=&quot;SELECT * FROM recipe_mst WHERE recipe_id = ${dataimporter.delta.recipe_id}&quot;
            deltaQuery=&quot;select recipe_id from recipe_mst WHERE updated_at &gt;= &#39;${dataimporter.last_index_time}&#39;&quot;
            &gt;
            &lt;field column=&quot;recipe_id&quot; name=&quot;recipe_id&quot; /&gt;
            &lt;field column=&quot;recipe_name&quot; name=&quot;recipe_name&quot; /&gt;
            &lt;field column=&quot;price&quot; name=&quot;price&quot; /&gt;
            &lt;entity name=&quot;recipe_genre_rel&quot;
                query=&quot;select * from recipe_genre_rel where recipe_id = &#39;${recipe_mst.recipe_id}&#39;&quot;&gt;
                &lt;entity name=&quot;genre_mst&quot; query=&quot;select * from genre_mst where genre_id = &#39;${recipe_genre_rel.genre_id}&#39;&quot;&gt;
                    &lt;field column=&quot;name&quot; name=&quot;genre&quot; /&gt;
                &lt;/entity&gt;
            &lt;/entity&gt;
            &lt;entity name=&quot;chef_mst&quot; pk=&quot;chef_id&quot;
                query=&quot;select * from chef_mst where chef_id = &#39;${recipe_mst.chef_id}&#39;&quot;
                deltaQuery=&quot;select chef_id from chef_mst where chef_id = 1&quot;
                parentDeltaQuery=&quot;select recipe_id from chef_mst where chef_id = ${chef_mst.chef_id} limit 1&quot;
                &gt;
                &lt;field column=&quot;name&quot; name=&quot;chef&quot; /&gt;
            &lt;/entity&gt;
        &lt;/entity&gt;
    &lt;/document&gt;
&lt;/dataConfig&gt;</code></pre>
</div>

<p>こうなっていた場合、<br />
deltaQuery=”select chef_id from chef_mst where chef_id = 1”<br />
これでヒットした chef_id を元に<br />
parentDeltaQuery=”select recipe_id from chef_mst where chef_id = ${chef_mst.chef_id} limit 1”<br />
が実行されて、<br />
deltaImportQuery=”SELECT * FROM recipe_mst WHERE recipe_id = ${dataimporter.delta.recipe_id}”<br />
これが実行される。  </p>

<h2 id="deletedpkquery-">(2014/5/12追記) deletedPkQuery について</h2>
<p>deltaImportQuery では、インデックスにのったデータの削除はされない。<br />
なので、データを削除する場合は deletedPkQuery を使用する。<br />
deletedPkQuery=”SELECT * FROM chef_mst WHERE status = 0”<br />
のようにしておけば status = 0 の chef が削除できる。  </p>

<h2 id="timezone-">(2014/5/12追記) Timezone の扱い</h2>
<p>Solr のクラスタを動かすマシンによると思うが、マシンの timezone が JST, mysql の timezone が UTC などの場合も<br />
普通にあると思う。なので<br />
CONVERT_TZ(‘${dataimporter.last_index_time}’, ‘Asia/Tokyo’, ‘GMT’)<br />
などとして変換してあげるといろいろ捗るかもしれない。  </p>

<h2 id="dih--javascript-">DIH の直前で Javascript でデータを加工する</h2>

<h3 id="updatehandler--updatechain">UpdateHandler と UpdateChain</h3>
<p>UpdateHandler と DIH の仕組みはこの図のようになっている。  </p>

<p><img src="http://gyazo.com/47cc999c6d1a7a31ed9c2bdd0080ce59.png" />
(改訂版 Apache Solr 入門より引用。)</p>

<p>DIH とは疎になっていて、 UpdateHandler はどの requestHandler でも使えるように見える。  </p>

<p>設定には<a href="https://github.com/vimtaku/solr_sample/commit/85c7439d239d55e3344cc20a32461536c3201eb8">この差分</a>
を参照。  </p>

<p>これを使えば、json のカラムからとった json を parse して multiValue なカラムに登録などができる。  </p>

<h3 id="section-10">なんかうまくいかない場合</h3>
<p>キャッシュされたデータを更新するとたまに更新されない。<br />
自分は一回 core を削除、 $SOLR_HOME の data ディレクトリを rm -rf している。<br />
もっといい、データ削除(もしくはいれかえ)の方法知っている人は教えて下さい。。  </p>

<h2 id="url">参考URL</h2>
<p><a href="http://ja.wikipedia.org/wiki/Lucene">http://ja.wikipedia.org/wiki/Lucene</a><br />
<a href="http://wiki.apache.org/solr/DataImportHandler">http://wiki.apache.org/solr/DataImportHandler</a><br />
<a href="http://ochien.seesaa.net/article/153191074.html">http://ochien.seesaa.net/article/153191074.html</a><br />
<a href="http://d.hatena.ne.jp/kudzu/20110513/1305313247">http://d.hatena.ne.jp/kudzu/20110513/1305313247</a><br />
<a href="http://d.hatena.ne.jp/bowez/20100405#p2">http://d.hatena.ne.jp/bowez/20100405#p2</a>  </p>

<p>_</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-13T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/solr/'>solr</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/10/docker-boot2docker-port-foward/">
		
			Docker_boot2docker_port_foward</a>
	</h2>
	<div class="entry-content">
		
<h2 id="os-x-108--docker">OS X 10.8 公式サポートで話題の Docker</h2>

<p><a href="http://qiita.com/kanekoa/items/cf3cabb23da69c609002">これ</a>をもとにとりあえず docker client を準備,<br />
docker server を建てた。  </p>

<h2 id="mac--localhost--telnet-11211--memcached-">mac の localhost に telnet 11211 したら memcached につながるようにしたい</h2>

<p><a href="https://www.docker.io/learn/dockerfile/level2/">https://www.docker.io/learn/dockerfile/level2/</a>
これをもとに Dockerfile を作った。 ここでは ubuntu を元にした vimtaku/memcached_1 とした。  </p>

<p>Dockefile</p>
<div>
  <pre><code class="bash"># Memcached
#
# VERSION       2.2

# use the ubuntu base image provided by dotCloud
FROM ubuntu

MAINTAINER Victor Coisne victor.coisne@dotcloud.com

# make sure the package repository is up to date
RUN echo &quot;deb http://archive.ubuntu.com/ubuntu precise main universe&quot; &gt; /etc/apt/sources.list
RUN apt-get update

# install memcached
RUN apt-get install -y memcached

# Launch memcached when launching the container
ENTRYPOINT [&quot;memcached&quot;]

# run memcached as the daemon user
USER daemon

# expose memcached port
EXPOSE 11211</code></pre>
</div>

<div>
  <pre><code class="bash">docker build -t vimtaku/memcached_1 - &lt; Dockerfile</code></pre>
</div>

<p>これでとりあえず memcached な image を作れる。  </p>

<div>
  <pre><code class="bash">docker run -p 11211:11211 vimtaku/memcached_1</code></pre>
</div>

<p>これで boot2docker -&gt; ubuntu が立つ。  </p>

<h2 id="section">追記(2014/02/13)</h2>
<p>成功法っぽいのを発見した。<br />
恥ずかしながら ssh port fowarding が -L オプションで できるっていうのを
<a href="http://motemen.hatenablog.com/entry/2014/02/11/Dockerfile_%E3%82%92%E5%85%83%E3%81%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E8%B5%B0%E3%82%89%E3%81%9B%E3%81%A6%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%81%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92">このブログ記事</a>
で初めて知った。  </p>

<p>まだ、やってないけど  </p>
<div>
  <pre><code class="bash">ssh -L 11211:localhost:11211 -p 2022 root@localhost</code></pre>
</div>

<p>とかすれば、 ssh port fowarding できるので、以下の手順は不要。</p>

<p>追記終わり。</p>

<h2 id="section-1">とりあえず確認するには</h2>

<p>とりあえず確認するには<br />
boot2docker ssh して ifconfig | grep -A4 docker0 すると<br />
172…. のような IP が見える。<br />
そこに対して telnet すると ちゃんと疎通できてる。<br />
ちなみに telnet localhost 11211 しても同様。  </p>

<p>あとは mac -&gt; boot2docker に 11211 疎通できればよい。<br />
ぐぐったら
<a href="http://fogstack.wordpress.com/2014/02/09/docker-on-osx-port-forwarding/">http://fogstack.wordpress.com/2014/02/09/docker-on-osx-port-forwarding/</a> の記事が見つかったのでほぼこれの通りに、</p>

<div>
  <pre><code class="bash">boot2docker down
したあと
VBoxManage modifyvm &quot;boot2docker-vm&quot; --natpf1 &quot;guestmemcached,tcp,,11211,,11211&quot;
boot2docker up
docker run -d -p 11211:11211 vimtaku/memcached_1</code></pre>
</div>

<p>これで mac から telnet localhost 11211 で行けた。たぶん。</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-10T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/docker/'>docker</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/09/life-feb-9/">
		
			2014/2/9</a>
	</h2>
	<div class="entry-content">
		
<h2 id="section">土日振り返り</h2>
<p>雪うざい。地味に perfect ruby を進めた。<br />
ruby 力が2くらい上がった。気がする。  </p>

<h2 id="section-1">勉強途中経過</h2>

<h3 id="section-2">進んでない</h3>
<ul>
  <li>rails tutorial 6 までやった</li>
</ul>

<h2 id="section-3">読書途中経過</h2>

<h3 id="section-4">進んだ</h3>
<ul>
  <li>パーフェクトルビー15章まで読んだ
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
</ul>

<h3 id="section-5">積んでる</h3>
<ul>
  <li>詳解UNIXプログラミング第7章まで読んだ</li>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>ネットワークはなぜつながるのか?</li>
  <li>chef-solo 入門 #23 まで読んだ(どっかで手を動かしながらやる)</li>
</ul>

<h3 id="section-6">読み終えた</h3>
<ul>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-09T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/08/life-feb-8/">
		
			2月の Solr には雪も Full</a>
	</h2>
	<div class="entry-content">
		
<h2 id="section">先週の振り返り</h2>
<p>先週は solr 祭りだった。<br />
solr は存在くらいしか知らなかったけど、非常によく出来たソフトウェアで<br />
これを使いこなせれば(使い方を知っていれば)非常によい価値を<br />
提供できる気がした。  </p>

<p>先々週はあんまり何やったか覚えていない。<br />
そういや 先週は docker とかめっちゃいいなと思ってたところだった。<br />
あとで触ってみよう。  </p>

<p>ところで東京のくせに雪とか降るのは生意気だと思う(北から目線。  </p>

<h2 id="section-1">勉強途中経過</h2>

<h3 id="section-2">進んでない</h3>
<ul>
  <li>rails tutorial 6 までやった</li>
</ul>

<h2 id="section-3">読書途中経過</h2>

<h3 id="section-4">進んだ</h3>
<ul>
  <li>詳解UNIXプログラミング第7章まで読んだ</li>
  <li>パーフェクトルビー10章まで読んだ
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
</ul>

<h3 id="section-5">積んでる</h3>
<ul>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>ネットワークはなぜつながるのか?</li>
  <li>chef-solo 入門 #23 まで読んだ(どっかで手を動かしながらやる)</li>
</ul>

<h3 id="section-6">読み終えた</h3>
<ul>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-08T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/08/ichiro/">
		
			イチロー</a>
	</h2>
	<div class="entry-content">
		
<h2 id="section">名言</h2>

<h3 id="by-">小さいことを積み重ねるのが、とんでもないところへ行くただひとつの道だと思っています。(by イチロー)</h3>

<p>はい、がんばりましょう。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-08T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ming-yan/'>名言</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/02/what-is-docker/">
		
			Docker の概要をしらべて触ってみた</a>
	</h2>
	<div class="entry-content">
		
<h2 id="toc">TOC</h2>
<ul id="markdown-toc">
  <li><a href="#toc">TOC</a></li>
  <li><a href="#section">はじめに</a></li>
  <li><a href="#docker-">docker とは</a></li>
  <li><a href="#lxc-">LXC とは</a></li>
  <li><a href="#aufs-union-fs-">aufs, Union FS とは</a>    <ul>
      <li><a href="#union-mount">union mount</a></li>
      <li><a href="#section-1">読み込み</a></li>
      <li><a href="#section-2">書き込み</a></li>
      <li><a href="#section-3">削除</a></li>
    </ul>
  </li>
  <li><a href="#github-">github 的な要素</a>    <ul>
      <li><a href="#section-4">出来上がりイメージ</a></li>
    </ul>
  </li>
  <li><a href="#section-5">所感</a></li>
  <li><a href="#section-6">参考文献</a></li>
</ul>

<h2 id="section">はじめに</h2>
<p>この記事では Docker について自分なりに理解するために調べたことをまとめる。<br />
Docker の tutorial は command line を ブラウザで実際に叩くところまでできるようになっているので、<br />
非常にわかりやすく入門できる。なので、 tutorial に関してはそっちをやったほうが良い。<br />
この記事は Docker ってこんな感じのやつなんだーってのが伝わればばいいなと思う。<br />
(ちなみに まだ Docker 歴は1日)</p>

<h2 id="docker-">docker とは</h2>
<p>LXC と aufs と github のようなものをうまくくみ合わせて提供される<br />
仮想化ソフトウェアだ。  </p>

<h2 id="lxc-">LXC とは</h2>
<p>Linux Container のこと。  </p>

<p><a href="http://gihyo.jp/admin/column/01/vm/2011/lxc_container">http://gihyo.jp/admin/column/01/vm/2011/lxc_container</a>によれば、  </p>
<blockquote><p>LXCの基本技術となるのが「コンテナ」と呼ばれる一種のリソース管理システムです。ファイルシステムの他，ホスト名やプロセス，ネットワークソケットなどのカーネルが扱うさまざまなリソースの管理テーブルを個々に用意し，これをコンテナごとに管理することで，コンテナごとに独立したOSのように動作させることができます。</p></blockquote>
<p>とある。<br />
また、カーネルの機能である <a href="http://ja.wikipedia.org/wiki/Cgroups">Cgroups</a> の説明をみれば非常によく理解できた。  </p>

<h2 id="aufs-union-fs-">aufs, Union FS とは</h2>
<p>ここに、 Union mount と Union type file system の資料がある。<br />
非常にわかりやすい説明だった。ここに、 aufs の説明もある。結構古いけど。。<br />
<a href="http://www.oreilly.co.jp/community/blog/2010/02/union-mount-uniontype-fs-part-1.html">http://www.oreilly.co.jp/community/blog/2010/02/union-mount-uniontype-fs-part-1.html</a>
ちょっとだけ簡単に自分用にまとめる。  </p>

<h3 id="union-mount">union mount</h3>
<p>filesystem A と filesystem B をマウントして、それぞれが file A, file B を同じディレクトリで持っていたとすると、<br />
union mount をつかったとき、fileA, file B の両方のファイルが見える。  </p>

<h3 id="section-1">読み込み</h3>
<p>open システムコールとかを通して呼ぶと、 union 機能が上から順に読んでいけば、差分的に一番新しいものを読める。<br />
両方のファイルシステムが fileA を持っていて、その内容がちがう場合、filesystem の mount の優先度(レイヤー順?)で<br />
どちらの filesystem の fileA が見えるか変わるんだと思う。  </p>

<h3 id="section-2">書き込み</h3>
<p>なんらかを書き込んで差分ができたとき、 上位ディスクとは違うものを保証しなければならないため、<br />
上位ディスクのものをコピーして書き込む。だからコピーオンライト。<br />
でもこの場合は、 copy-up と呼ばれて、プロセス fork でいうそれとは区別されている模様。  </p>

<h3 id="section-3">削除</h3>
<p>ファイルが削除されても、上位ディスクには存在しているため、事実上削除ができない。<br />
なので 特別なファイルを作成することで 消えたように見せる。(DB で言う論理削除みたいなもんだと認識)<br />
whiteout という。  </p>

<h2 id="github-">github 的な要素</h2>
<p><a href="https://index.docker.io">index.docker.io</a> レポジトリに image を push できる。<br />
memcached を <a href="https://www.docker.io/learn/dockerfile/">Dockerfile によって image を作る tutorial</a> があるので、それをやった。<br />
それでできた Dockerfile  を使って repository に push した例を以下に示す。<br />
ちなみに、 <a href="https://index.docker.io/account/">https://index.docker.io/account/</a> にあらかじめ登録しておいた。  </p>

<div>
  <pre><code class="bash">vagrant@ubuntu-12:~$ docker login
Username: vimtaku
Password:
Email: ******@gmail.com
Login Succeeded

vagrant@ubuntu-12:~$ docker build -t vimtaku/memcached_sample - &lt; Dockerfile

vagrant@ubuntu-12:~$ docker images
REPOSITORY                 TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
vimtaku/memcached_sample   latest              242bd405025e        22 seconds ago      217.1 MB
run_memcached              latest              5f1cda03f61c        17 hours ago        217.1 MB
memcached                  latest              9166d484dda8        17 hours ago        217.1 MB
brand_new_memcached        latest              7bdd82d0abf7        20 hours ago        217.1 MB
memcached_new              latest              c18168a45363        20 hours ago        245.5 MB
ubuntu                     12.10               426130da57f7        7 days ago          127.6 MB
ubuntu                     quantal             426130da57f7        7 days ago          127.6 MB
ubuntu                     10.04               8589d4e9c7c6        7 days ago          139.6 MB
ubuntu                     lucid               8589d4e9c7c6        7 days ago          139.6 MB
ubuntu                     12.04               72e10143e54a        7 days ago          125.9 MB
ubuntu                     latest              72e10143e54a        7 days ago          125.9 MB
ubuntu                     precise             72e10143e54a        7 days ago          125.9 MB
ubuntu                     13.10               721f07d19f96        7 days ago          144.6 MB
ubuntu                     saucy               721f07d19f96        7 days ago          144.6 MB
ubuntu                     13.04               476aa49de636        7 days ago          133.6 MB
ubuntu                     raring              476aa49de636        7 days ago          133.6 MB

vagrant@ubuntu-12:~$ docker push vimtaku/memcached_sample
The push refers to a repository [vimtaku/memcached_sample] (len: 1)
Sending image list
Pushing repository vimtaku/memcached_sample (1 tags)
511136ea3c5a: Image already pushed, skipping 
b74728ce6435: Image already pushed, skipping 
72e10143e54a: Image already pushed, skipping 
28d8e9cef54f: Image successfully pushed 
6be17bb13216: Image successfully pushed 
1b910f3ee9b7: Image successfully pushed 
18e04c08eb9b: Image successfully pushed 
2e32ba041afa: Image successfully pushed 
1cf353d00dd8: Image successfully pushed 
242bd405025e: Image successfully pushed 
Pushing tags for rev [242bd405025e] on {https://registry-1.docker.io/v1/repositories/vimtaku/memcached_sample/tags/latest}</code></pre>
</div>

<p><br /></p>

<h3 id="section-4">出来上がりイメージ</h3>
<p><img src="http://gyazo.com/6a99a7bdffa6ce80369dad852461aacb.png" style="width:100%;" /></p>

<h2 id="section-5">所感</h2>
<p>この記事では、 docker の一番の利点だと感じている、 image を簡単に作って試す、みたいな部分は書いていない。<br />
すごい早さで image を作り出すことができるのには感動した。そこが一番の利点だと思う。<br />
あと、<a href="http://www.oreilly.co.jp/community/blog/2010/02/union-mount-uniontype-fs-part-1.html">この oreilly の資料</a>は 3回くらい読む価値はありそうだ。  </p>

<h2 id="section-6">参考文献</h2>
<p><a href="http://ja.wikipedia.org/wiki/LXC">http://ja.wikipedia.org/wiki/LXC</a><br />
<a href="http://gihyo.jp/admin/column/01/vm/2011/lxc_container">http://gihyo.jp/admin/column/01/vm/2011/lxc_container</a><br />
<a href="http://ja.wikipedia.org/wiki/Cgroups">http://ja.wikipedia.org/wiki/Cgroups</a><br />
<a href="http://www.oreilly.co.jp/community/blog/2010/02/union-mount-uniontype-fs-part-1.html">http://www.oreilly.co.jp/community/blog/2010/02/union-mount-uniontype-fs-part-1.html</a><br />
<a href="http://teppeis.hatenablog.com/entry/docker">http://teppeis.hatenablog.com/entry/docker</a><br />
<a href="http://shibayu36.hatenablog.com/entry/2013/12/30/173949">http://shibayu36.hatenablog.com/entry/2013/12/30/173949</a><br />
<a href="http://2013.8-p.info/japanese/06-22-docker.html">http://2013.8-p.info/japanese/06-22-docker.html</a>  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-02T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/docker/'>docker</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/5/" class="prev">Prev</a>
    
    
        <a href="/blog/page/7/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    vimtaku

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-30103097-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>

<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>vimtaku blog</title>
	<meta name="author" content="vimtaku">

	
	<meta name="description" content="web エンジニアのためのデータベース技術入門をざっくり読んだ この人の感想ブログがいい感じ。
なので、自分で気になったあたりを調べたところとかを、以下にメモしていく。 Sharding と更新性能
RAID を組んだ マスタの場合、冗長性だけでなく並列性においても有利である。 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="vimtaku blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="http://vimtakublog.qolwu.com/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">vimtaku blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:vimtaku.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/vimtaku" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/vimtaku" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:vimtaku.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/28/book-webengineer-database/">
		
			Web エンジニアのためのデータベース技術入門をざっくり読んだ</a>
	</h2>
	<div class="entry-content">
		<h2 id="web-">web エンジニアのためのデータベース技術入門をざっくり読んだ</h2>

<p><a href="http://hamasyou.com/blog/2012/05/09/4774150207/">この人の感想ブログがいい感じ</a>。<br />
なので、自分で気になったあたりを調べたところとかを、以下にメモしていく。  </p>

<h3 id="sharding-">Sharding と更新性能</h3>
<p>RAID を組んだ マスタの場合、冗長性だけでなく並列性においても有利である。<br />
MySQLではマスタはマルチスレッドで動作するが、<br />
スレーブはシングルスレッドで動いているから、スレーブのほうが負荷がかかりやすく、<br />
さらに raid のせいで I/O での差が発生する。<br />
なので、スレーブだけ SSD とか、SSD のなかでもさらに高性能な PCI-express SSD を使うと余裕になるっていう話。  </p>

<h3 id="hash-join-">Hash JOIN について</h3>
<p>MySQL では join とかするときは、残念なことに MySQL5.6 でも Nested Loop に変換されてしまう。<br />
MariaDB とか PostgreSQL とかでは Hash Join が実装されているようだ。<br />
Hash JOIN のほうがすごく早い場合がある、が、単純に Hash Join のほうが早いというわけではない。<br />
 <a href="http://www.mysqlperformanceblog.com/2012/05/31/a-case-for-mariadbs-hash-joins/">mysql performance blog</a>の結論部をたいして無い英語力で翻訳してみると、  </p>

<blockquote><p>Based on the above information and the benchmark results for different test cases, we can see where Hash Joins work best and where they don’t. First of all Hash joins only work for equijoins. Hash join work best when you are joining very big tables with no WHERE clause, or a WHERE clause on a non-indexed column. They also provide big improvement in query response time when you are joining tables with no indexes on the join condition (Full Join). The best performance with Hash Join can be achieved when the left table can fit completely in the join buffer, or when the least amount of buffer refills are needed, as each buffer refill means a scan of the right-side table. However, Hash joins do not outperform BNL or BKA when you are joining a really small subset of rows, as then scanning the right-side table becomes costly in comparison. Block Nested Loop Join would perform better than Hash Join when you are joining two tables on a PK column such that both tables are read in PK order. One use case that I can think of for hash joins is data warehouse applications that need to run reporting queries that need to join on lookup tables which tend to be small mostly. What use cases can you think of</p></blockquote>

<blockquote><p>まず Hash join は inner join じゃなきゃそもそもうごかない。  <br />Hash join は where 句なしの大きいテーブルか、  <br />where 使っているけど インデックスはられていないカラムの条件指定の時に効果を発揮するよ。  <br />もしくは、index がはられていない列同士の結合とかにもだいぶ効果発揮するよ。  <br />ベストパフォーマンス発揮するタイミングは、左のテーブルがジョインバッファに全部収まる  <br />(最低限再度バッファに入れる時に入るサイズ)ときだ。  <br />それは右のテーブルを読みきった時にまたジョインバッファ更新するから。  <br />すげぇ小さいテーブルとか、右のテーブルに const 検索条件が使われている時とかは BNL とか BKA とかのほうがいい感じだぜ。  <br />BNL は PK での 検索条件とか、 PK での sort order 使ってるときに Hash join よりいいぜ。  <br />まぁ、一つ思いつくのは data ware hause Application とかでレポートする処理とか書く時にかなり早くなりそうだよね。  <br />あとなんかある？</p></blockquote>

<p>って感じだ。<br />
なるほど、そう考えると格段と良くなるとは言えないが、場合によっては相当効力がありそうだ。<br />
しかもグラフを見ると、なるほど、たしかに、そうとうパフォーマンスが上がっている場所がある。<br />
というか mysql 5.5 と 5.6 の差が違いすぎてウケる。  </p>

<h4 id="section">参考:</h4>
<p><a href="http://d.hatena.ne.jp/interdb/20131020/1382280437">http://d.hatena.ne.jp/interdb/20131020/1382280437</a><br />
<a href="http://www.mysqlperformanceblog.com/2012/05/31/a-case-for-mariadbs-hash-joins/">http://www.mysqlperformanceblog.com/2012/05/31/a-case-for-mariadbs-hash-joins/</a>  </p>

<h3 id="section-1">スレッドプールについて</h3>
<p>MariaDB だとスレッドプールが使用できるが、MySQL 5.6 ではその機能はない。<br />
エンタープライズ版とかだと用意されているらしい。 ちなみに MySQL6 とかで実装されるらしい。  </p>

<h3 id="mysql-">MySQL チューニングについて</h3>
<p>これらの記事がおそらくとても参考になるので、本番運用前にチェックしてみるとよいかも。<br />
<a href="http://yakst.com/ja/posts/200">http://yakst.com/ja/posts/200</a><br />
<a href="http://nippondanji.blogspot.jp/2009/03/mysql7.html">http://nippondanji.blogspot.jp/2009/03/mysql7.html</a><br />
<a href="http://dsas.blog.klab.org/archives/50860867.html">http://dsas.blog.klab.org/archives/50860867.html</a><br />
<a href="http://www.slideshare.net/kenmasu/ss-12604339">http://www.slideshare.net/kenmasu/ss-12604339</a>  </p>

<p>以下メモ<br />
show engine innodb status;<br />
で ロックが発生していないか見る。  </p>

<p>これで遅いトランザクションの洗い出しが可能。<br />
https://github.com/yoshinorim/MySlowTranCapture  </p>

<p>この辺は見直すとよいかも。</p>
<div>
  <pre><code class="sql">mysql&gt; show global variables like &#39;%innodb_lock_wait_timeout%&#39;;</code></pre>
</div>

<h3 id="rds-">RDS におけるリストアについて</h3>
<p>オンプレミスな DB のリストアなら、<br />
ある地点のスナップショットのリストア + バイナリログをロールフォワードだと思うけど<br />
RDS ならどうするんだろうと思ってちょっと調べたけど、最初から MultiAZ にしておけば<br />
自動フェイルオーバーしてくれる模様。<br />
しかし3-5分くらいかかる模様なので、その間システムが落ちるのかと思うと結構しんどい。<br />
<a href="http://ijin.github.io/blog/2013/05/21/custom-non-rds-multi-az-mysql-replication/">手動でフェイルオーバー</a>
とかもあってこっちは復旧はすごく早いけどこれも結構デメリットはあるみたい。<br />
何を取るかだとは思うけど(おそらく組織レベルでサービスの停止が許せるかどうか)、<br />
メンテの楽さを考えると RDS 任せのほうが楽な気はする。  </p>

<h3 id="section-2">所感</h3>
<p>この本に関しては、業務でやっている、やっていたことが結構書かれていた。<br />
無意識レベルでやっていたことが結構書かれていたのでそういうところは飛ばして読んだ。<br />
でも、mysql のチューニングのあたりなどはあまりやったことがない経験だった。
前職では運用チームの人たちがいたのでその人達で閉じていた知識だと思うので、<br />
今の職場で活かせるようにチューニングしたいと思った。  </p>

<p>Wikipedia や Google は MariaDB を採用しているらしい。<br />
まだ枯れているという印象は全然ないけど、実際に使われていることや、ほぼ MySQL だったりするところ、<br />
スレッドプールが使えるあたりはかなり変わってきそう。<br />
hash join も使えるので、オプティマイザが賢ければかなりその恩恵受けられそう。<br />
<a href="http://d.hatena.ne.jp/interdb/20131020/1382280437">オプティマイザ比較しているブログ</a>
見る限り、実は postgresql が頑張っている。<br />
postgresql は前前職で使っていたが vacuum の印象が強くてあんまりいいイメージはない。<br />
今度自分のプロダクトを作るときには MariaDB を使ってみようと思う。  </p>

<h3 id="section-3">参考</h3>
<ul>
  <li><a href="http://dba.stackexchange.com/questions/43439/is-there-any-way-to-force-mysql-use-hash-join-instead-of-nested-loop-join">http://dba.stackexchange.com/questions/43439/is-there-any-way-to-force-mysql-use-hash-join-instead-of-nested-loop-join</a></li>
  <li><a href="http://nippondanji.blogspot.jp/2009/03/mysql7.html">http://nippondanji.blogspot.jp/2009/03/mysql7.html</a>  </li>
  <li>[http://www.atmarkit.co.jp/ait/articles/0503/24/news107<em>2.html](http://www.atmarkit.co.jp/ait/articles/0503/24/news107</em>2.html)</li>
</ul>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-28T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/mysql/'>mysql</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/10/jbuilder-tips/">
		
			Jbuilder のフラグメントキャッシュで、配列で書きたい場合とハッシュで書きたい場合のキャッシュを共通化したい</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">結論</h2>
<p>views/book/_book.jbuilder  </p>
<div>
  <pre><code class="ruby">json.cache! book do
  _j = book.to_builder.target!
    JSON.parse(_j).each do |k,v|
        json.set! k, v
    end
end</code></pre>
</div>

<p>controller で @tmpl[:book] が set されていると仮定<br />
views/book/show.jbuilder  </p>
<div>
  <pre><code class="ruby">json.book do
  json.partial! &#39;book/book&#39;, book: @tmpl[:book]
end</code></pre>
</div>

<p>controller で @tmpl[:books] が set されていると仮定<br />
views/book/list.jbuilder  </p>
<div>
  <pre><code class="ruby">json.books @tmpl[:books], partial:&#39;book/book&#39;, as: :book</code></pre>
</div>

<h2 id="section-1">背景</h2>
<p>単体表示に  </p>
<div>
  <pre><code class="ruby">{
    book: {
        bookId: &quot;moge&quot;
    }
}</code></pre>
</div>

<p>複数表示に  </p>
<div>
  <pre><code class="ruby">{
    books:[
    {
      bookId: &quot;moge&quot;
    },
    {
      bookId: &quot;moge2&quot;
    }
    ]
}</code></pre>
</div>

<p>としたいみたいなやつがググっても全然出てこなかったので。</p>

<h2 id="section-2">所感</h2>
<p>まぁこうは普通しないわなぁ。</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-10T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/28/jbuilder-layout/">
		
			Jbuilder で 共通パラメータを付与したい時は Layout を使うといいかも</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">前提</h2>
<ul>
  <li>rails4</li>
  <li>jbuilder(1.5.3)</li>
</ul>

<h2 id="section-1">背景</h2>
<p>jbuilder を使うと、 api のレスポンスをシンプルに定義できる。<br />
例えば、hoge_controller.rb#new の場合に<br />
app/views/hoge/new.jbuilder とかを用意しておいて、<br />
そこに template で返したい値などを書いて定義できる。<br />
しかし、共通で値を返したい場合どうするんだってことになって<br />
いろいろ考えた結果以下に落ち着いた。  </p>

<h2 id="section-2">解法</h2>
<p>layout を使う。  </p>

<p>controller にたとえば<br />
layout ‘api/application.jbuilder’ 
などと定義しておく。  </p>

<p>それで上記の例で言うと、 hoge_controller.rb#new では<br />
app/views/hoge/new.jbuilder が呼ばれるので、  </p>

<p>app/views/hoge/new.jbuilder</p>
<div>
  <pre><code class="ruby">json.from_hoge &quot;from_hoge_param&quot;</code></pre>
</div>

<p>layouts/api/application.jbuilder  </p>
<div>
  <pre><code class="ruby"># common に値を付与
json.common &quot;common_param_is_here&quot;
# controller の @hoge を参照できる
json.hoge @hoge
# template の値を付与
JSON.parse(yield).each do |k,v|
  json.set! k, v
end</code></pre>
</div>

<p>とかしておくと良いのかもしれない。<br />
結果は
{common:”common_param_is_here”, fromHoge:”from_hoge_param”, hoge:”hoge_from_controller”}
てな感じになる。  </p>

<p>ちなみに camelCase には公式の通り、 Jbuilder.key_format camelize: :lower でできる。</p>

<p>上記は、まだ実践してないけど手元で試してみた見たかんじこれで行けそう。  </p>

<h2 id="section-3">所感</h2>
<p>もっといい方法あれば教えて下さい。  </p>

<h2 id="section-4">蛇足</h2>
<p>stack over flow とかで書いてある render! を定義する方法や<br />
json.render JSON.parse(yield)  だとうまく行かなかった。  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-28T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/23/life-march-23/">
		
			Life_march_23</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">先週振り返り</h2>
<p>引き続き、ものすごく仕事が忙しくてやばかった。<br />
でも進んできた感があるので、この調子でがんばろう。<br />
(先週と同じ</p>

<h2 id="section-1">週末振り返り</h2>
<p>3連休だった。<br />
その割に大したことはしなかった。<br />
自由が丘でうさぎカフェに行って初めてうさぎとすごく触れ合った。<br />
うさぎはすごく現金なやつで、餌をあげるときしかきてくれなかった。 
いつか猫カフェに行きたい。  </p>

<h2 id="section-2">偉大な目標</h2>
<p>全く進んでない</p>

<h2 id="section-3">完成してないゲーム</h2>
<p>全く進んでない..</p>

<h2 id="section-4">勉強途中経過</h2>

<h3 id="section-5">進んでない</h3>
<ul>
  <li>rails tutorial 6 まで</li>
</ul>

<h2 id="section-6">読書途中経過</h2>

<h3 id="section-7">進んだ</h3>
<ul>
  <li>ネットワークはなぜつながるのか?(2章)</li>
  <li>とある本2章まで読んだ</li>
</ul>

<h3 id="section-8">積んでる</h3>
<ul>
  <li>詳解UNIXプログラミング第8章まで読んだ</li>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>DDD ショートバージョン</li>
  <li><a href="http://www.infoq.com/jp/minibooks/domain-driven-design-quickly">http://www.infoq.com/jp/minibooks/domain-driven-design-quickly</a></li>
  <li>ミクシィ公認 スマホアプリ開発実践ガイド［iOS/Android両対応］ [Kindle版]</li>
  <li>論語入門</li>
</ul>

<h3 id="section-9">まだ積んでないけど読む</h3>
<ul>
  <li>nginxの本</li>
</ul>

<h3 id="section-10">読み終えた</h3>
<ul>
  <li>(2014/3/1)chef-solo 入門
    <ul>
      <li>ザーッと目を通し直したらほぼ理解出来てたので読み終えたことにする</li>
    </ul>
  </li>
  <li>(2014/3/1)パーフェクトルビー
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
  <li>(2014/2/16)(さらっと)日経Linux 2月号</li>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-23T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/17/memo-before-migrate/">
		
			Memo_before_migrate</a>
	</h2>
	<div class="entry-content">
		<h2 id="memo">memo</h2>
<p>before_migrate は、migrate しようがしまいが呼ばれる。</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-17T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/16/life-march-16/">
		
			3月ももう半ば</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">先週振り返り</h2>
<p>引き続き、ものすごく仕事が忙しくてやばかった。<br />
でも進んできた感があるので、この調子でがんばろう。  </p>

<h2 id="section-1">不摂生</h2>
<p>不摂生がたたってついに体に異常をきたし始めたのでそろそろ<br />
控えようと思う。  </p>

<h2 id="section-2">週末振り返り</h2>

<h3 id="section-3">プチ旅行</h3>
<p>三浦半島の先にある三浦海岸というところで河津桜の祭りがあるとのことで<br />
春を先取りしてきた。<br />
おどろくべきことに、すでに桜は散り始めていて、ピークは2週間前くらいのように感じた。<br />
もちろん桜だけではもったいないので、三崎口というつぎの駅辺りでよくとれるらしい  </p>

<p><a href="http://tabelog.com/kanagawa/A1406/A140603/14002818/">紀川さんで</a> マグロを寿司でいただいてきた。<br />
そこで頼んだ特上ずしは、すごく美味しかった。<br />
トロがうますぎて別でさらに注文してしまった。<br />
そして、梅酒がとても美味しかった。ある種、梅酒目当てでも寄れるくらいおいしかった。  </p>

<h3 id="section-4">クライアント認証について再び勉強</h3>
<p>あとで書くけど、クライアント認証やサーバのオレオレ認証局などについて再勉強した。<br />
すごく理解が深まった感がある。  </p>

<h2 id="section-5">来週は</h2>
<p>4日しかないし、不摂生しないように頑張る。  </p>

<h2 id="section-6">勉強途中経過</h2>

<h3 id="section-7">進んでない</h3>
<ul>
  <li>rails tutorial 6 まで</li>
</ul>

<h2 id="section-8">読書途中経過</h2>

<h3 id="section-9">進んだ</h3>
<ul>
  <li>ネットワークはなぜつながるのか?(2章)</li>
</ul>

<h3 id="section-10">積んでる</h3>
<ul>
  <li>詳解UNIXプログラミング第8章まで読んだ</li>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>DDD ショートバージョン</li>
  <li><a href="http://www.infoq.com/jp/minibooks/domain-driven-design-quickly">http://www.infoq.com/jp/minibooks/domain-driven-design-quickly</a></li>
  <li>ミクシィ公認 スマホアプリ開発実践ガイド［iOS/Android両対応］ [Kindle版]</li>
  <li>論語入門</li>
</ul>

<h3 id="section-11">まだ積んでないけど読む</h3>
<ul>
  <li>nginxの本</li>
</ul>

<h3 id="section-12">読み終えた</h3>
<ul>
  <li>(2014/3/1)chef-solo 入門
    <ul>
      <li>ザーッと目を通し直したらほぼ理解出来てたので読み終えたことにする</li>
    </ul>
  </li>
  <li>(2014/3/1)パーフェクトルビー
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
  <li>(2014/2/16)(さらっと)日経Linux 2月号</li>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/16/apache-nginx-client-certificate/">
		
			クライアント認証をもう一度やる@nginx</a>
	</h2>
	<div class="entry-content">
		<h2 id="toc">TOC</h2>
<ul id="markdown-toc">
  <li><a href="#toc">TOC</a></li>
  <li><a href="#section">概要</a></li>
  <li><a href="#section-1">やったこと</a>    <ul>
      <li><a href="#section-2">補足</a>        <ul>
          <li><a href="#config-">config による直接的な制限</a></li>
          <li><a href="#revoke-">revoke による証明書の失効</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#nginx-ssl-">nginx による、SSL 設定とクライアント認証</a>    <ul>
      <li><a href="#section-3">ちなみに</a></li>
    </ul>
  </li>
  <li><a href="#section-4">所感</a></li>
</ul>

<h2 id="section">概要</h2>
<p>前回は、資料のようにやればできるって感じだったけど、<br />
理解して一つづつもう一度やってみたかったのでもう一度やってみた。  </p>

<h2 id="section-1">やったこと</h2>
<p>基本的には以下のサイトにしたがってすすめた。<br />
<a href="http://server-setting.info/centos/private-ca-cert.html">こちらのサイト</a><br />
基本的に前回の記事では、CA(.sh) という、<br />
openssl の ca を扱うのに便利な付属スクリプトは使っていなかったんだけど、<br />
今回のは CA(.sh) を使ってすすめた。<br />
というか、ほとんどやったことは上記のサイト通りなので、上記のサイト通りやると良いとおもう。<br />
解説もものすごく丁寧にされているので。<br />
なので、自分がやったことの補足だけ書いていく。  </p>

<h3 id="section-2">補足</h3>

<h4 id="config-">config による直接的な制限</h4>
<p>まず、背景として、vimtaku, hogetaku というユーザにそれぞれクライアント認証したい。<br />
それで、それぞれのクライアントの鍵はサーバで作成する。  </p>

<p>なので、サーバ側で  </p>

<ul>
  <li>クライアント用(vimtaku,hogetaku二人別々)の公開鍵と秘密鍵を作り、  </li>
  <li>csr をだし、</li>
  <li>それを ca が 署名して、</li>
  <li>pfx に変換して</li>
</ul>

<p>最終的に、配りたい対象ユーザのブラウザに渡すかんじになった。</p>

<p>client認証はしていて、さらに config レベルで、アクセスを制限したい場合には、
ssl.conf に</p>
<div>
  <pre><code class="apache">&lt;Location /&gt;
SSLRequire (    %{SSL_CIPHER} !~ m/^(EXP|NULL)/ \
            and ( \
                  %{SSL_CLIENT_S_DN_CN} eq &quot;vimtaku&quot; \
                  or %{SSL_CLIENT_S_DN_CN} eq &quot;hogetaku&quot; \
                ) \
            )
&lt;/Location&gt;</code></pre>
</div>

<p>などと書けば設定できる。  </p>

<p>他にも条件は書けそうなので、パラメータに関しては<a href="http://httpd.apache.org/docs/2.4/mod/mod_ssl.html">こちらを参考</a>に。  </p>

<p>デバッグとしては</p>
<div>
  <pre><code class="apache">CustomLog logs/ssl_request_log \
  &quot;%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x %{SSL_CLIENT_S_DN_O}x %{SSL_CLIENT_S_DN_CN}x %{SSL_CLIENT_S_DN}x \&quot;%r\&quot; %b&quot;</code></pre>
</div>

<p>としてログだすとよいかもしれない。</p>

<h4 id="revoke-">revoke による証明書の失効</h4>
<p>config ではなく、 revoke で、たとえば hogetaku が会社辞めたとかで配った証明書を失効させる方法として、  </p>

<div>
  <pre><code class="bash">cd /etc/pki/CA
cp serial crlnumber
openssl ca -gencrl -revoke  /etc/pki/CA/certs/hogetaku.ec2-xxxxxxxxxxxxx.ap-northeast-1.compute.amazonaws.com.crt -config /etc/pki/tls/openssl-client.cnf
cd /etc/pki/CA/crl/
openssl ca -gencrl -out crl.pem</code></pre>
</div>

<p>として、</p>

<p>そして<br />
/etc/httpd/conf.d/ssl.conf に、</p>
<div>
  <pre><code class="apache">SLCACertificateFile /etc/pki/CA/cacert.pem</code></pre>
</div>

<p>の下くらいに  </p>
<div>
  <pre><code class="apache">SSLCARevocationCheck chain
SSLCARevocationFile /etc/pki/CA/crl/crl.pem</code></pre>
</div>

<p>を追加した。  </p>

<p>それで、サーバを再起動すれば、revoke した証明書を持つクライアントはアクセスできなくなる(400)。</p>

<p>ちなみに revoke は
/etc/pki/CA/newcerts/内のファイル か /etc/pki/CA/newcerts/certs 内のファイルのどちらでもよさそう。  </p>

<h2 id="nginx-ssl-">nginx による、SSL 設定とクライアント認証</h2>
<p>はっきり言ってなんの問題もない</p>

<div>
  <pre><code class="bash">sudo yum -y install nginx</code></pre>
</div>

<p>/etc/nginx/conf を編集。  </p>

<div>
  <pre><code class="nginx">server {
        listen       443;
        server_name  localhost;

        ssl                  on;
        ssl_certificate      /etc/pki/CA/certs/ec2-xxxxxxxxxxxxx.ap-northeast-1.compute.amazonaws.com.crt.pem;
        ssl_certificate_key  /etc/pki/CA/private/ec2-xxxxxxxxxxxxx.ap-northeast-1.compute.amazonaws.com.key;
        ssl_verify_client on;
        ssl_client_certificate /etc/pki/CA/cacert.pem;
        ssl_crl /etc/pki/CA/crl/crl.pem;

        ssl_session_timeout  5m;

        ssl_protocols  SSLv2 SSLv3 TLSv1; 
        ssl_ciphers  HIGH:!aNULL:!MD5; 
        ssl_prefer_server_ciphers   on;

        location / {
            root   html;
            index  index.html index.htm;
        }
    }</code></pre>
</div>

<p>大体、 apache と同じような設定を行えば使用できる。  </p>

<h3 id="section-3">ちなみに</h3>
<p>revoke したのをやっぱ辞めたいって場合は<br />
/etc/pki/CA/index.txt の<br />
R の行の R を V にして、 その次の次のカラムの 時間を 消してから、<br />
openssl ca -gencrl -out crl.pem<br />
してやればよい。  </p>

<h2 id="section-4">所感</h2>
<p>複雑だけど、さすがに2週連続で日曜日使えばだいたいわかる。<br />
でももっと奥深く知るにはちゃんと本を読むべきだと思う。  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/dev/'>dev</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/10/ruby-webrick-onewriner/">
		
			Ruby の WEBRick のワンライナーでサーバが立つかすぐ確認する</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">ワンライナー</h2>
<div>
  <pre><code class="ruby">ruby -e &quot;require &#39;webrick&#39;; server = WEBrick::HTTPServer.new( {:BindAddress =&gt; &#39;0.0.0.0&#39;, :Port =&gt; 80}); trap(:INT){server.shutdown}; server.start;&quot;</code></pre>
</div>

<h2 id="section-1">普通の方</h2>
<div>
  <pre><code class="ruby">require &#39;webrick&#39;
server = WEBrick::HTTPServer.new({:BindAddress =&gt; &#39;0.0.0.0&#39;, :Port =&gt; 80})
trap(:INT){server.shutdown}
server.start</code></pre>
</div>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-10T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/10/life-march-9/">
		
			3月2週目</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">先週振り返り</h2>
<p>ものすごく仕事が忙しくてやばかった。<br />
rails に慣れてきた感は出てきたが、まだまだ大変だ。  </p>

<p>病院行きたいけど忙しいからなかなか行けないんだよなぁ。  </p>

<h2 id="section-1">週末振り返り</h2>
<p>vimplugin 書いたし、ちょっと今後やりそうなことの技術調査ができたし、<br />
気になっていたこともわかってよかった。  </p>

<h2 id="section-2">困っていること</h2>
<p>くっそ忙しくてちょっと余裕がない。<br />
まぁでもいまはちょっとやるしかないのでがんばる。  </p>

<h2 id="gem">最近の gem</h2>
<p>gem ‘default_value_for’
これデフォルト値いい感じに埋めれてなんか便利だった</p>

<h2 id="section-3">勉強途中経過</h2>

<h3 id="section-4">進んでない</h3>
<ul>
  <li>rails tutorial 6 まで</li>
</ul>

<h2 id="section-5">読書途中経過</h2>

<h3 id="section-6">進んだ</h3>
<ul>
  <li>ネットワークはなぜつながるのか?(1章)</li>
</ul>

<h3 id="section-7">積んでる</h3>
<ul>
  <li>詳解UNIXプログラミング第8章まで読んだ</li>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>DDD ショートバージョン</li>
  <li><a href="http://www.infoq.com/jp/minibooks/domain-driven-design-quickly">http://www.infoq.com/jp/minibooks/domain-driven-design-quickly</a></li>
  <li>ミクシィ公認 スマホアプリ開発実践ガイド［iOS/Android両対応］ [Kindle版]</li>
  <li>論語入門</li>
</ul>

<h3 id="section-8">まだ積んでないけど読む</h3>
<ul>
  <li>nginxの本</li>
</ul>

<h3 id="section-9">読み終えた</h3>
<ul>
  <li>(2014/3/1)chef-solo 入門
    <ul>
      <li>ザーッと目を通し直したらほぼ理解出来てたので読み終えたことにする</li>
    </ul>
  </li>
  <li>(2014/3/1)パーフェクトルビー
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
  <li>(2014/2/16)(さらっと)日経Linux 2月号</li>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-10T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/10/amazon-linux-phpmysqladmin-clientauth/">
		
			Amazon Linux に Phpmyadmin を入れてクライアント認証する</a>
	</h2>
	<div class="entry-content">
		<h2 id="toc">TOC</h2>
<ul id="markdown-toc">
  <li><a href="#toc">TOC</a></li>
  <li><a href="#section">概要</a></li>
  <li><a href="#section-1">下準備</a></li>
  <li><a href="#db-">DB の設定をあれこれする</a></li>
  <li><a href="#phpmyadmin--">phpmyadmin のアクセス制限,今回は クライアント認証する前提なので全開放</a></li>
  <li><a href="#section-2">クライアント認証</a>    <ul>
      <li><a href="#p12-">p12 のインストールについて</a></li>
    </ul>
  </li>
  <li><a href="#section-3">参考文献</a></li>
</ul>

<h2 id="section">概要</h2>
<p>amazon linux で phpmyadmin(httpd) を入れてクライアント認証するパターンになったのでやってみた。  </p>

<h2 id="section-1">下準備</h2>

<div>
  <pre><code class="bash">## apache と phpmyadmin が入る
sudo yum --enablerepo=epel install phpmyadmin
## mod_ssl
sudo yum install mod24_ssl
sudo yum install openssl-devel</code></pre>
</div>

<h2 id="db-">DB の設定をあれこれする</h2>
<div>
  <pre><code class="bash">sudo vim /etc/phpMyAdmin/config.inc.php</code></pre>
</div>

<h2 id="phpmyadmin--">phpmyadmin のアクセス制限,今回は クライアント認証する前提なので全開放</h2>
<div>
  <pre><code class="bash">sudo vim /etc/httpd/conf.d/phpMyAdmin.conf</code></pre>
</div>

<p>とりあえず全開放</p>
<div>
  <pre><code class="bash">## L16 あたりに
Require all granted
## L26 あたりに
Allow from 0.0.0.0</code></pre>
</div>

<div>
  <pre><code class="bash">/etc/httpd/conf.d/virtualhost.conf</code></pre>
</div>

<div>
  <pre><code class="apache">&lt;Directory &quot;/phpmyadmin&quot;&gt;
    Options ExecCGI
    AllowOverride all
    Order Allow,Deny
    Allow from all
    RewriteEngine On
    RewriteCond %{SERVER_PORT} 80
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/%{REQUEST_URI} [R,L]
    LogLevel alert rewrite:trace3
&lt;/Directory&gt;</code></pre>
</div>

<h2 id="section-2">クライアント認証</h2>
<p>については
<a href="https://github.com/mechamogera/MyTips/wiki/Apache%E3%81%A7%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E8%AA%8D%E8%A8%BC%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">この資料</a>
がものっすごい参考になる。<br />
というかこのままやれば良い。  </p>

<h3 id="p12-">p12 のインストールについて</h3>
<p>Google Chrome  はキーチェーンに入れたら行けた。<br />
Vimperator(Firefox) についてはブラウザに pom.p12 を入れたら行けた。  </p>

<h2 id="section-3">参考文献</h2>
<p>phpmyadmin についてはこれが非常に役に立つ。<br />
<a href="http://sanketdangi.com/post/56623052533/phpmyadmin-on-amazon-ec2-manage-amazon-rds">http://sanketdangi.com/post/56623052533/phpmyadmin-on-amazon-ec2-manage-amazon-rds</a><br />
クライアント認証に関しては<br />
<a href="https://github.com/mechamogera/MyTips/wiki/Apache%E3%81%A7%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E8%AA%8D%E8%A8%BC%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B">https://github.com/mechamogera/MyTips/wiki/Apache%E3%81%A7%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E8%AA%8D%E8%A8%BC%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B</a>  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-10T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/dev/'>dev</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/2/" class="prev">Prev</a>
    
    
        <a href="/blog/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    vimtaku

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-30103097-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>

<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>vimtaku blog</title>
	<meta name="author" content="vimtaku">

	
	<meta name="description" content="背景
devise を知るには warden を知るべしと思ったので warden を勉強した。
大体 warden はわかったので warden の仕組みをかぶせた認証エンジンである
devise を触ってみる。 では早速、以下メモ。 /Users/mac/try_devise/ &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="vimtaku blog" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="http://vimtakublog.qolwu.com/favicon.ico" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">vimtaku blog</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:vimtaku.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/vimtaku" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/vimtaku" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:vimtaku.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/02/z_devise1/">
		
			Devise に入門してみる</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">背景</h2>
<p><a href="/blog/2014/03/02/warden/">devise を知るには warden を知るべしと思ったので warden を勉強した。</a><br />
大体 warden はわかったので warden の仕組みをかぶせた認証エンジンである<br />
<a href="https://github.com/plataformatec/devise">devise</a> を触ってみる。  </p>

<h2 id="section-1">では早速、以下メモ。</h2>

<div>
  <pre><code class="bash">/Users/mac/try_devise/try_devise% be rails g devise:install
      create  config/initializers/devise.rb
      create  config/locales/devise.en.yml
===============================================================================

Some setup you must do manually if you haven&#39;t yet:

  1. Ensure you have defined default url options in your environments files. Here
     is an example of default_url_options appropriate for a development environment
     in config/environments/development.rb:

       config.action_mailer.default_url_options = { :host =&gt; &#39;localhost:3000&#39; }

     In production, :host should be set to the actual host of your application.

  2. Ensure you have defined root_url to *something* in your config/routes.rb.
     For example:

       root :to =&gt; &quot;home#index&quot;

  3. Ensure you have flash messages in app/views/layouts/application.html.erb.
     For example:

       &lt;p class=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;
       &lt;p class=&quot;alert&quot;&gt;&lt;%= alert %&gt;&lt;/p&gt;

  4. If you are deploying on Heroku with Rails 3.2 only, you may want to set:

       config.assets.initialize_on_precompile = false

     On config/application.rb forcing your application to not access the DB
     or load models when precompiling your assets.

  5. You can copy Devise views (for customization) to your app by running:

       rails g devise:views

===============================================================================</code></pre>
</div>

<p>bundle exec rails g devise User<br />
予めcreate database しておく<br />
bundle exec rake db:migrate  </p>

<p>すると出来上がる。</p>
<div>
  <pre><code class="sql">CREATE TABLE `users` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `email` varchar(255) NOT NULL DEFAULT &#39;&#39;,
  `encrypted_password` varchar(255) NOT NULL DEFAULT &#39;&#39;,
  `reset_password_token` varchar(255) DEFAULT NULL,
  `reset_password_sent_at` datetime DEFAULT NULL,
  `remember_created_at` datetime DEFAULT NULL,
  `sign_in_count` int(11) NOT NULL DEFAULT &#39;0&#39;,
  `current_sign_in_at` datetime DEFAULT NULL,
  `last_sign_in_at` datetime DEFAULT NULL,
  `current_sign_in_ip` varchar(255) DEFAULT NULL,
  `last_sign_in_ip` varchar(255) DEFAULT NULL,
  `created_at` datetime DEFAULT NULL,
  `updated_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `index_users_on_email` (`email`),
  UNIQUE KEY `index_users_on_reset_password_token` (`reset_password_token`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |</code></pre>
</div>

<p>config/routes.rb に行が追加されている。  </p>
<blockquote><p>devise_for :users</p></blockquote>

<p>localhost:3000 にアクセスすると<br />
<img src="http://gyazo.com/ff5a659072c28ff0934f6ec51ca74dc3.png" /><br />
/users/にものすごくたくさんいろいろできている。  </p>

<p>login した後の、 users/edit とか<br />
<img src="http://gyazo.com/27ca0f5038500c7796c51c81973755a9.png" />  </p>

<h2 id="view-">独自の view を使うには</h2>

<p>独自の view を使うには、<br />
scope (admin モデルと user モデルがいる場合に使用)のロジックを使う方法と、<br />
view を単純に上書きする方法がある。<br />
当然、用途に応じて admin と user のモデルを使うんなら scope を使えば良い。<br />
単純にひとつだけなら、 view を上書きする方法が良い。  </p>

<p>view を上書きする方法では、<br />
be rails generate devise:views して、<br />
devise/sessions/new.html.erb<br />
を編集などすれば良い。  </p>

<p>scope を使う方法では、<br />
config/initializers/devise.rb に<br />
config.scoped_views = true<br />
を追加して、<br />
be rails generate devise:views users<br />
すれば、<br />
users/sessions/new.html.erb<br />
などが使われるようになる。  </p>

<h2 id="section-2">所感</h2>
<p>全然入門できてない。続きはまた書く。</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-02T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/devise/'>devise</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/02/warden/">
		
			Devise を知るにはまず Warden を知るが良い</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">背景</h2>
<p>devise という gem があるが、warden をベースにした認証の仕組みだということだった。<br />
devise を知るには、まず warden を知らなければなるまい。<br />
そう思った俺は warnden を rack ベースでいじってみることにした。  </p>

<h2 id="warden-">warden とは</h2>

<p>これのこと。<br />
<a href="https://github.com/hassox/warden">https://github.com/hassox/warden</a><br />
wiki が充実していたのでかなりわかりやすかった。<br />
<a href="https://github.com/hassox/warden/wiki">https://github.com/hassox/warden/wiki</a>  </p>

<h2 id="section-1">とりあえずやってみる、以下メモ書き。</h2>

<p>config.rb</p>
<div>
  <pre><code class="ruby">require &#39;rack&#39;
require &#39;pp&#39;
require &#39;warden&#39;

class Application

  def call(env)
    request = Rack::Request.new(env)
    response = if request.path_info = &#39;/&#39;
                 body = &quot;#{request.request_method}: Hello! #{request.params[&#39;name&#39;]}!&quot;
                 Rack::Response.new(body, &quot;200&quot;, {&#39;Content-Type&#39; =&gt; &#39;text/plain&#39;})
               else
                 Rack::Response.new(&#39;Not Found&#39;, &quot;404&quot;, {&#39;Content-Type&#39; =&gt; &#39;text/plain&#39;})
               end
    response.finish
  end

end


app = Rack::Builder.new do
  use Rack::Session::Cookie, :secret =&gt; &quot;replace this with some secret key&quot;

  use Warden::Manager do |manager|
    manager.default_strategies :password, :basic
    #manager.failure_app = BadAuthenticationEndsUpHere
  end

  run lambda { |env| Application.new().call(env) }
end

run app</code></pre>
</div>

<p>基本的に, default_strategies で定義した順に行われて、一つでも成功したら成功になる模様。  </p>

<p>cookie セットされている<br />
<img src="http://gyazo.com/be238cfa0282a588b1fad41ae91dd804.png" />
<img src="http://gyazo.com/95a09e0d872829e8e0fef2204728cdaa.png" /></p>

<p>試しに nil を返した時。<br />
<img src="http://gyazo.com/de50e8c049809e31a41231c7b6fb1cd4.png" /></p>

<p>明らかに error ハンドラがないぞッて感じのエラーが出ているので、<br />
雰囲気でBadAuthenticationEndsUpHere クラスを足してみる。  </p>

<div>
  <pre><code class="ruby">class BadAuthenticationEndsUpHere
  def self.call(env)
    p env
    p &quot;BadAuthenticationEndsUpHere&quot;
    Rack::Response.new(&#39;Not Found&#39;, &quot;404&quot;, {&#39;Content-Type&#39; =&gt; &#39;text/plain&#39;})
  end
end</code></pre>
</div>

<p>思い通りだ。 error ハンドラとして BadAuthenticationEndsUpHere クラスが呼ばれた。<br />
<img src="http://gyazo.com/f44ae6997b92aab707291851645c565a.png" /></p>

<p>それでは、正しく期待している serialize_from_session が動くように User.get を定義する。  </p>

<div>
  <pre><code class="ruby">def get(id)
    ## 永続化されたものから引いてうまく引けたと過程して返す
    return User.new(id)
  end</code></pre>
</div>

<p>1回目、とりあえずログインされるはず。<br />
<img src="http://gyazo.com/9a31a0967443614441eeb729e34d6ba7.png" /></p>

<p>サーバのデバッグログ  </p>
<blockquote><p>&#8220;Authenticate!!!!!!!!!!!!&#8221;<br />&#8220;serialize into session!!!!!!!!!!!!&#8221;</p></blockquote>
<p>ログから、セッションに値が仕込まれた模様。</p>

<p>2回目、セッションから値を引いてみる。<br />
<img src="http://gyazo.com/e5db07a78d1f75119ffa76740d10032b.png" />
あれ、ミス。。あ、 serialize_from_session が読んでるのは User.get(id) だから class method だった。。<br />
修正して再チャレンジ。  </p>

<p>ちゃんときたっぽい！<br />
<img src="http://gyazo.com/c1225bebd28bd178e9c9aaa5967d8c89.png" /></p>

<p>デバッグログ</p>
<blockquote><p>&#8220;Authenticate!!!!!!!!!!!!&#8221;<br />&#8220;serialize from session!!!!!!!!!!!!&#8221;<br />127.0.0.1 - - [01/Mar/2014 18:54:54] &#8220;GET /?password=hoge HTTP/1.1&#8221; 200 13 0.0022</p></blockquote>

<p>get されている模様！  </p>

<p>これで user にアクセスできる。  </p>
<div>
  <pre><code class="ruby">p &quot;warden user is &quot;
p env[&#39;warden&#39;].user</code></pre>
</div>

<p>ドキュメントを読むと、<br />
Warden::Strategies で定義した #valid? に関しては、定義されてようがなかろうが呼ばれるらしい。  </p>

<p>試しにこの時点で #valid? で nil を返すと次の strategy にチャレンジがうつった。<br />
すべての strategy で失敗したら、 failure_app が呼ばれる。  </p>

<p>特筆すべきは、ここで呼ばれるのが /unauthenticated だということだ。<br />
この url http://localhost:9292/?password=hoge を叩くと<br />
127.0.0.1 - - [01/Mar/2014 19:01:45] “GET /unauthenticated?password=hoge HTTP/1.1” 404 9 0.0012<br />
がデバッグログに表示されている。  </p>

<div>
  <pre><code class="ruby">class BadAuthenticationEndsUpHere
  def self.call(env)
    p &quot;in BadAuthenticationEndsUpHere!!!!!!!!!!!!&quot;
    request = Rack::Request.new(env)

    p &quot;request.path_info is &quot;
    p request.path_info

    Rack::Response.new(&#39;Not Found&#39;, &quot;404&quot;, {&#39;Content-Type&#39; =&gt; &#39;text/plain&#39;})
  end
end</code></pre>
</div>

<p>をデバッグとして試しに書いてみた。<br />
やはり、内部的に path_info を unauthenticated に書き換えているようだ。<br />
これは lib/warden/manager.rb のあたりを見ればわかる。<br />
def process_unauthenticated(env, options={})<br />
や<br />
def call_failure_app(env, options = {})<br />
で実際にそのように書かれている。<br />
と思ったら<br />
<a href="https://github.com/hassox/warden/wiki/Failures">https://github.com/hassox/warden/wiki/Failures</a><br />
ここにめっちゃそのように書いてあった。  </p>

<p>halt! や success など便利なメソッドが strategy で使える模様。<br />
<a href="https://github.com/hassox/warden/wiki/Strategies">https://github.com/hassox/warden/wiki/Strategies</a>
詳細はコチラを参照。  </p>

<p>このような認証の仕組みが rack で使えて、 認証自体が strategy パターンになっているので<br />
いい感じに他の人が作った strategy を使えるようになっている。  </p>

<p><a href="https://github.com/hassox/warden/wiki/Setup#advanced-setup-with-scopes">https://github.com/hassox/warden/wiki/Setup#advanced-setup-with-scopes</a><br />
これを見ると、warden は、認証の scope を分けられるようになっている。<br />
それぞれの認証で、違うロジックを定義して、認証できるようだ。<br />
特に指定がない場合は、 env[‘warden’] は user として認証する。<br />
しかし、これは上書きができるようだ。<br />
default の設定上書きとは別に、明示的にスコープを指定することもできる。  </p>
<div>
  <pre><code class="ruby">env[&#39;warden&#39;].authenticate! :scope =&gt; :api</code></pre>
</div>

<h3 id="callback">callback</h3>

<div>
  <pre><code class="ruby">&quot;serialize into session!!!!!!!!!!!!&quot;
&quot;after_set_user caled!&quot;
&quot;auth is&quot;
Warden::Proxy:70106638122900 @config={:default_scope=&gt;:default, :scope_defaults=&gt;{}, :default_strategies=&gt;{:_all=&gt;[:password, :basic]}, :intercept_401=&gt;true, :failure_app=&gt;BadAuthenticationEndsUpHere}
&quot;logout called!!!!!!!!!!!&quot;
&quot;in BadAuthenticationEndsUpHere!!!!!!!!!!!!&quot;
&quot;request.path_info is &quot;
&quot;/unauthenticated&quot;
127.0.0.1 - - [01/Mar/2014 19:55:10] &quot;GET /unauthenticated?password=hoge HTTP/1.1&quot; 404 9 0.0025</code></pre>
</div>

<p>これも結構参考になる。<br />
<a href="https://gist.github.com/lukesutton/107966">https://gist.github.com/lukesutton/107966</a></p>

<h2 id="section-2">所感</h2>
<p>warden 大体わかった。  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-02T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/02/life-march-2/">
		
			3月が来た</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">先週振り返り</h2>
<p>一週間開いてしまった。<br />
やっぱ life 的なブログは毎週書かないとダメな気がしてきた。  </p>

<p>先週はお腹の調子がひたすら悪くてしんどかった。<br />
rails っていう覚えゲーをひたすらこなしているんだけど<br />
とにかく雪崩のように覚えることがあって大変だ。  </p>

<p>でも二回目以降(知識が増えたら)もっと楽になるだろうから今だけだと思って頑張ろう。  </p>

<p>ついに花粉が本気出し始めた。<br />
早めに病院に行ってこようと思う。<br />
ちなみにロラタジンってくすりが俺にとってはすごく効いた(去年)。  </p>

<h2 id="section-1">困っていること</h2>
<p>筋トレのモチベーションがどうも上がらない。<br />
太る一方だし。。<br />
あと ruby に駆り立てられてすごい頭を使ってるからずいぶん疲れている。<br />
ruby の勉強というか調査とかのせいであんまり本を最近読めてない。<br />
これは改善すべきだ。  </p>

<h2 id="section-2">勉強途中経過</h2>

<h3 id="section-3">進んでない</h3>
<ul>
  <li>rails tutorial 6 まで</li>
</ul>

<h2 id="section-4">読書途中経過</h2>

<h3 id="section-5">積んでる</h3>
<ul>
  <li>詳解UNIXプログラミング第8章まで読んだ</li>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>ネットワークはなぜつながるのか?</li>
  <li>DDD ショートバージョン</li>
  <li><a href="http://www.infoq.com/jp/minibooks/domain-driven-design-quickly">http://www.infoq.com/jp/minibooks/domain-driven-design-quickly</a></li>
  <li>論語入門</li>
</ul>

<h3 id="section-6">読み終えた</h3>
<ul>
  <li>(2014/3/1)chef-solo 入門
    <ul>
      <li>ザーッと目を通し直したらほぼ理解出来てたので読み終えたことにする</li>
    </ul>
  </li>
  <li>(2014/3/1)パーフェクトルビー
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
  <li>(2014/2/16)(さらっと)日経Linux 2月号</li>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-02T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/24/factory-girl-active-support-concern/">
		
			Factory_girl_active_support_concern</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">ぼやき</h2>
<p>rspec でテストを書いていて、ある(concern)モジュールを include した active record なクラスで、<br />
どうしても、ActiveSupport::Concern を include したところに インスタンスメソッドを定義しても<br />
NoMethodError(undefined method) になってしまう..  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-24T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/boyaki/'>ぼやき</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/nikkei-linux-feb/">
		
			日経Linux 2月号を読んだ</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">概要</h2>
<p><a href="http://www.amazon.co.jp/%E6%97%A5%E7%B5%8C-Linux-%E3%83%AA%E3%83%8A%E3%83%83%E3%82%AF%E3%82%B9-2014%E5%B9%B4-02%E6%9C%88%E5%8F%B7/dp/B00H8X84E6">日経Linux 2月号(2014)</a>
に、カーネルの特集記事があったので買って読んでみた。<br />
今まで知らなかった部分とか、便利そうなことについて、以下に記載する。  </p>

<h2 id="section-1">メモリ管理</h2>
<p>buddy システム, スラブアロケータについて書かれていた。<br />
この本よりもっと詳しく書かれたページを発見したのでコチラを参照。<br />
<a href="http://www.coins.tsukuba.ac.jp/~yas/coins/os2-2011/2012-01-17/">http://www.coins.tsukuba.ac.jp/~yas/coins/os2-2011/2012-01-17/</a></p>

<h2 id="systemtap">systemtap</h2>
<p>system tap とは <a href="https://access.redhat.com/site/ja/node/289453">https://access.redhat.com/site/ja/node/289453</a> にある通り  </p>

<blockquote><p>実行している Linux カーネルで簡易情報を取得できるようにする革新的なツールです。</p></blockquote>
<p>である。  </p>

<h3 id="install-centos">install 方法(@CentOS)</h3>
<p>vagrant で建てた CentOS を使ってやってみる。<br />
Vagrantfile 的に<br />
config.vm.box = “Berkshelf-CentOS-6.3-x86_64-minimal”<br />
この box を使っている人は以下の通りでインストールできると思います。  </p>

<div>
  <pre><code class="bash">sudo yum -y install systemtap
cd /tmp
wget http://debuginfo.centos.org/6/x86_64/kernel-debuginfo-common-x86_64-2.6.32-279.el6.x86_64.rpm
wget http://debuginfo.centos.org/6/x86_64/kernel-debug-debuginfo-2.6.32-279.el6.x86_64.rpm
sudo yum install kernel-debuginfo-common-x86_64-2.6.32-279.el6.x86_64.rpm
sudo yum install kernel-debug-debuginfo-2.6.32-279.el6.x86_64.rpm

# これで stap がつかえる
stap

## 追記
(これだと probe.kernel が使えないっぽい.. 要調査。)</code></pre>
</div>

<p>あとは
<a href="http://sourceware.org/systemtap/examples/">http://sourceware.org/systemtap/examples/</a><br />
ここから<br />
vm.tracepoints.stp や, sched_switch.stp を落として来て実行できる。  </p>

<p>(参考)<br />
<a href="http://stts.hatenablog.com/entry/20090614/1244952417">http://stts.hatenablog.com/entry/20090614/1244952417</a>  </p>

<h2 id="section-2">プロセスのメモリ割付について</h2>
<p>/proc/[processId]/maps (これをメモリーマップと呼ぶ。)を参照すれば、どのようにメモリが割り付けられているかがわかる。  </p>

<div>
  <pre><code class="bash">vi hoge.c
-----
#include &lt;stdio.h&gt;

int main(void) {
  char hoge[4096] = &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;;

printf(&quot;sleep start\n&quot;);
  sleep(500000);
printf(&quot;sleep stop\n&quot;);
  return 0;
}

ps aux | grep a.out
vagrant  19157  0.0  0.0   3928   408 pts/1    S+   04:41   0:00 ./a.out
vagrant  19164  0.0  0.0 107456   948 pts/0    S+   04:42   0:00 grep a.out


cd /proc/
cat /proc/19157/maps

00400000-00402000 r-xp 00000000 fd:00 3590                               /tmp/a.out
00601000-00602000 rw-p 00001000 fd:00 3590                               /tmp/a.out
7fdf912e5000-7fdf91470000 r-xp 00000000 fd:00 3071                       /lib64/libc-2.12.so
7fdf91470000-7fdf9166f000 ---p 0018b000 fd:00 3071                       /lib64/libc-2.12.so
7fdf9166f000-7fdf91673000 r--p 0018a000 fd:00 3071                       /lib64/libc-2.12.so
7fdf91673000-7fdf91674000 rw-p 0018e000 fd:00 3071                       /lib64/libc-2.12.so
7fdf91674000-7fdf91679000 rw-p 00000000 00:00 0
7fdf91679000-7fdf91699000 r-xp 00000000 fd:00 3437                       /lib64/ld-2.12.so
7fdf9188e000-7fdf91891000 rw-p 00000000 00:00 0
7fdf91896000-7fdf91898000 rw-p 00000000 00:00 0
7fdf91898000-7fdf91899000 r--p 0001f000 fd:00 3437                       /lib64/ld-2.12.so
7fdf91899000-7fdf9189a000 rw-p 00020000 fd:00 3437                       /lib64/ld-2.12.so
7fdf9189a000-7fdf9189b000 rw-p 00000000 00:00 0
7fff2a0dc000-7fff2a0f1000 rw-p 00000000 00:00 0                          [stack]
7fff2a1b4000-7fff2a1b5000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</code></pre>
</div>

<p>下から見ると、 systemcall が呼ばれる領域(カーネル仮想空間)があるのと、 stack が積まれる領域があるのと、<br />
shared object がリンクされている領域と、 テキスト(プログラム)が格納されている領域があるのが見て取れる。  </p>

<p>左端から、仮想アドレス、アクセス属性、データオフセット、 デバイスのメジャー番号とマイナー番号、 inode, ファイル名とのこと。  </p>

<h2 id="section-3">カーネル時計</h2>
<p>Linux カーネルは 起動時には、PC の内蔵時計を使用するが、それ移行は独自のカーネル時計を使用する。<br />
ミリ秒からナノ秒の処理が必要であるため。  </p>

<h2 id="io">I/Oスケジューラー</h2>
<p>入出力するブロックデータを並び替えて入出力を高速化できるもの。  </p>

<p><a href="http://city.hokkai.or.jp/~hachikun/IOScheduler.html">http://city.hokkai.or.jp/~hachikun/IOScheduler.html</a><br />
<a href="[http://city.hokkai.or.jp/~hachikun/IOScheduler.html]">http://www.valinux.co.jp/technologylibrary/document/linuxkarnel/cfq0001/</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/kernel/'>kernel</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/mysql-workbench-rails/">
		
			MySQL Workbench で Rails の Migration ファイルを吐き出す</a>
	</h2>
	<div class="entry-content">
		<h2 id="toc">TOC</h2>
<ul id="markdown-toc">
  <li><a href="#toc">TOC</a></li>
  <li><a href="#section">概要</a></li>
  <li><a href="#mysql-workbench--ss">Mysql workbench の SS</a></li>
  <li><a href="#section-1">手順</a>    <ul>
      <li><a href="#mysql-workbench-rails-exporter-plugin-">1. mysql workbench rails exporter plugin をダウンロード</a></li>
      <li><a href="#mysql-workbench-">2. mysql workbench のインストール</a></li>
      <li><a href="#section-2">3. プラグインのインストールと実行</a></li>
    </ul>
  </li>
  <li><a href="#section-3">所感</a></li>
</ul>

<h2 id="section">概要</h2>
<p>mysql workbench っていう MySQL のER図を作るみたいなツールがある。<br />
CUI硬派のため、いままでは使ったことなかったけど、<br />
今回はじめて使ってみると結構いい感じだった。<br />
それを rails のマイグレーションファイルに吐き出したいなぁと思っていたら、<br />
それっぽいプラグインを見つけたので、その方法を書いておく。  </p>

<h2 id="mysql-workbench--ss">Mysql workbench の SS</h2>
<p><img src="http://gyazo.com/f15f8824bbfdd3bb3dccd514b697f5e5.png" /></p>

<h2 id="section-1">手順</h2>

<h3 id="mysql-workbench-rails-exporter-plugin-">1. mysql workbench rails exporter plugin をダウンロード</h3>
<p><a href="http://sourceforge.net/projects/railsexporter/">http://sourceforge.net/projects/railsexporter/</a>
ここから、 rails exporter を落としてくる。  </p>

<h3 id="mysql-workbench-">2. mysql workbench のインストール</h3>
<p>新しい workbench ツールに、上記プラグインが対応していなかったので、 ちょっと古いやつで試したら動作した。<br />
<a href="http://dev.mysql.com/downloads/tools/workbench/">http://dev.mysql.com/downloads/tools/workbench/</a> から、
Looking for previous GA versions? をたどると、 mysql-workbench-gpl-5.2.47-osx-i686.dmg  が落とせる。<br />
これをインストールする。  </p>

<h3 id="section-2">3. プラグインのインストールと実行</h3>
<p>mysql workbench のタブから、 “SCRIPTING &gt; INSTALL PLUGIN/MODULE …” で、展開した 1 の zip の .lua ファイルを選択する。<br />
mysql workbench を再起動して、 “PLUGINS &gt; CATALOG &gt; Rails Exporter 1.0.1” を選択すれば、あら不思議、<br />
$HOME に Rails_Explorer ディレクトリが。<br />
db と model が出来上がるので、あとはそれをよしなに利用すれば良い。  </p>

<h2 id="section-3">所感</h2>
<p>実際、このあとに、 mysql に接続して、ER図を吐き出すやつやってみたけど、<br />
まぁ当然、テーブル的にリレーションしてないわけだから、ER図もリレーションしてなくて、見づらい。<br />
raisl には ERD 生成ツールみたいなのがあるらしいので、<br />
最初の一回くらいしか使えないかもしれないけど、ないよりはいいかなぁ。<br />
ちなみに出来上がるファイルは若干修正が必要だと思う。<br />
ちゃんと mwb のほうで書いていれば大丈夫かもだけど。。<br />
mwb の方で、カラムに複数行のコメントを入れておくと、出力された時にダメなので、<br />
コメントを1行にするか、複数行の場合は先頭に#を入れると良いかもしれない。<br />
あと、 unsigned int を作りたいけど、うまいことやってくれなくて、<br />
gem “activerecord-mysql-unsigned”, “~&gt; 0.0.1”
これを入れて、手動で integer のカラムに :unsgined =&gt; true した。  </p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/16/life-feb-16/">
		
			2/16</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">先週振り返り</h2>
<p>先週も solr 力をかなり高める感じだった。<br />
docker がリアルに流行り始めているので、本格的に勉強したいところ。<br />
でも家のネットワークが遅くてちょっと厳しいんだよなぁ。<br />
なんかお腹の調子がずっと悪くてしんどかった。<br />
あと、雪の日に自宅待機したら迷惑かけてしまったので、今後は極力休まない。  </p>

<p>あんまり本が読めなかったので、気合入れて読む。<br />
あと、どうでもいいけど、 MBA の容量が 128GB で 94% とか言ってて積んでる感ある。  </p>

<h2 id="section-1">土日振り返り</h2>
<p>あんまり多く時間を取れなかったが、日経 linux 読んだのと、workbench の件をそこそこやった。  </p>

<h2 id="section-2">勉強途中経過</h2>

<h3 id="section-3">進んでない</h3>
<ul>
  <li>rails tutorial 6 までやった</li>
</ul>

<h2 id="section-4">読書途中経過</h2>

<h3 id="section-5">進んだ</h3>
<ul>
  <li>詳解UNIXプログラミング第8章まで読んだ</li>
</ul>

<h3 id="section-6">積んでる</h3>
<ul>
  <li>オペレーティングシステム 6章まで読んだ</li>
  <li>Webエンジニアのためのデータベース技術［実践］入門 7章まで読んだ</li>
  <li>ネットワークはなぜつながるのか?</li>
  <li>chef-solo 入門 #23 まで読んだ(どっかで手を動かしながらやる)</li>
  <li>パーフェクトルビー15章まで読んだ
    <ul>
      <li>手を動かしながら ver</li>
    </ul>
  </li>
  <li>論語入門</li>
</ul>

<h3 id="section-7">読み終えた</h3>
<ul>
  <li>(2014/2/16)(さらっと)日経Linux 2月号</li>
  <li>(2014/2/8)プログラマの数学</li>
  <li>(2014/2/6)(一周目、さらっと)[改訂新版] Apache Solr入門 ~オープンソース全文検索エンジン</li>
  <li>(2014/1/26)マスタリングTCP/IP 入門第5版 とりあえず読み切った</li>
  <li>(2014/1/13)読む筋トレ</li>
  <li>(2014/1/8)ザ・コーチ 最高の自分に出会える「目標の達人ノート」</li>
</ul>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-16T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/life/'>life</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/14/octopress/">
		
			Jekyll から Octopress に10 分で移行する</a>
	</h2>
	<div class="entry-content">
		<h2 id="section">背景</h2>
<p>デザインが見づらいって言われたので辛くなったから、<br />
octopress にノリで移行してみた。<br />
当方、 jekyll-bootstrap を使っていて、 octopress も普通に jekyll 使っているので<br />
問題なく移行できると思ったら移行できた。  </p>

<h2 id="section-1">手順</h2>
<p>大体こんなかんじでいける。空気さえ読めれば行ける感じ。  </p>

<div>
  <pre><code class="bash">git clone git://github.com/imathis/octopress.git octopress
cd octopress/
bundle install
rake install
rake preview
rake -T
vim config.rb
rake preview
rake setup_github_pages

## Rakefile の L269 の git push を -f するようにした。すでにレポジトリがあったから。
vim Rakefile

rake deploy

cp -a $HOME/jekyll-bootstrap/_posts/* .

## JB setup を記事に埋め込んでいるのがあったのでそれをケア(互換性のため)
mkdir $HOME/octopress/source/includes/JB
cp -a $HOME/jekyll-bootstrap/_includes/JB/setup $HOME/octopress/source/includes/JB</code></pre>
</div>

<h2 id="section-2">ちなみに</h2>
<p>テーマはコチラを使わせてもらった。<br />
<a href="http://zespia.tw/Octopress-Theme-Slash/">http://zespia.tw/Octopress-Theme-Slash/</a><br />
how to install 通りにやれば適用できる。  </p>

<p>Octopress テーマ集みたいなのはコチラ。<br />
<a href="http://opthemes.com/">http://opthemes.com/</a>  </p>

<h2 id="section-3">参考資料</h2>

<p><a href="http://joelmccracken.github.io/entries/octopress-is-pretty-sweet/">http://joelmccracken.github.io/entries/octopress-is-pretty-sweet/</a></p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-14T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/octopress/'>octopress</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/13/solr-sample/">
		
			今更 Solr 入門</a>
	</h2>
	<div class="entry-content">
		
<h2 id="toc">TOC</h2>
<ul id="markdown-toc">
  <li><a href="#toc">TOC</a></li>
  <li><a href="#section">この記事について</a></li>
  <li><a href="#section-1">予備知識</a>    <ul>
      <li><a href="#apache-solr-">Apache Solr とは</a></li>
      <li><a href="#lucene-">Lucene とは</a></li>
    </ul>
  </li>
  <li><a href="#section-2">スキーマを作ってみよう</a>    <ul>
      <li><a href="#section-3">フィールドタイプについて</a></li>
      <li><a href="#section-4">フィールドについて</a>        <ul>
          <li><a href="#section-5">テキストフィールドの定義</a></li>
          <li><a href="#section-6">ダイナミックフィールド</a></li>
          <li><a href="#section-7">ユニークキーフィールド</a></li>
          <li><a href="#section-8">コピーフィールド</a></li>
        </ul>
      </li>
      <li><a href="#core-admin--core-">core admin で core を作成</a></li>
    </ul>
  </li>
  <li><a href="#section-9">サンプルデータを入れてみよう</a></li>
  <li><a href="#dihdataimporthandler-">DIH(DataImportHandler) について</a>    <ul>
      <li><a href="#solr-config-">solr config に記述する</a></li>
      <li><a href="#mysql--connector-">mysql の connector をダウンロードして設置</a></li>
      <li><a href="#mysql--db-data-configxml-">mysql の設定, db-data-config.xml の設定など</a></li>
    </ul>
  </li>
  <li><a href="#deltaquery-">deltaQuery について</a>    <ul>
      <li><a href="#deltaquery--parentdeltaquery-">deltaQuery と parentDeltaQuery の関係</a></li>
    </ul>
  </li>
  <li><a href="#deletedpkquery-">(2014/5/12追記) deletedPkQuery について</a></li>
  <li><a href="#timezone-">(2014/5/12追記) Timezone の扱い</a></li>
  <li><a href="#dih--javascript-">DIH の直前で Javascript でデータを加工する</a>    <ul>
      <li><a href="#updatehandler--updatechain">UpdateHandler と UpdateChain</a></li>
      <li><a href="#section-10">なんかうまくいかない場合</a></li>
    </ul>
  </li>
  <li><a href="#url">参考URL</a></li>
</ul>

<h2 id="section">この記事について</h2>
<p>今更ながら Solr に興味が出てきたので、自分用にまとめてみる。<br />
あくまで自分用なので、ある程度わかっている人じゃないと本記事は無意味です。恐縮ながら。<br />
前提として、 この記事は <a href="http://www.amazon.co.jp/Apache-Solr%E5%85%A5%E9%96%80-~%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3%E3%82%BD%E3%83%BC%E3%82%B9%E5%85%A8%E6%96%87%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3-Software-Design/dp/4774161632">改訂新版 Apache Solr入門 ~オープンソース全文検索エンジン</a> を読みながら進めた。   </p>

<p>まずは、予備知識として Apache Solr とはなにか、 Lucene とはなにかについて書く。<br />
次に、スキーマを作って、サンプルデータ を 手動でのデータインポートで index に登録する手順について書く。<br />
手動でのデータインポートは大変なので、mysql からデータをインポートするクローラ(DIH)について書く。
最後に、 MySQL にある json を保存するカラムのデータを、 Javascript を使って整形し、 index に保存することについて書く。  </p>

<h2 id="section-1">予備知識</h2>

<h3 id="apache-solr-">Apache Solr とは</h3>
<p>全文検索システムである。<br />
全文検索エンジン Lucene をベースに、管理画面やキャッシュ、クラスタリングなどの機能がある。<br />
ちなみに Java で書かれている。<br />
<a href="http://ja.wikipedia.org/wiki/Apache_Solr">http://ja.wikipedia.org/wiki/Apache_Solr</a></p>

<h3 id="lucene-">Lucene とは</h3>
<blockquote><p>Lucene（ルシーン）は、Javaで記述された全文検索ソフトウェアである。<br />あらかじめ蓄積した大量のデータから、指定したキーワードを探し出す機能を持つ。Javaのクラスライブラリとして提供される。</p></blockquote>
<p><a href="http://ja.wikipedia.org/wiki/Lucene">http://ja.wikipedia.org/wiki/Lucene</a>
なるほど。</p>

<h2 id="section-2">スキーマを作ってみよう</h2>
<p>スキーマを作って、サンプルデータを入れてみる。<br />
ここでは、 料理人が複数いて、自分の料理をうるみたいなものを想定する。<br />
Solr の schema.xml で、スキーマを定義することができる。  </p>

<p>以下に、 schema.xml の fileds の設定例を載せる。  </p>
<div>
  <pre><code class="xml">&lt;fields&gt;
    &lt;field name=&quot;recipe_id&quot;   type=&quot;int&quot;     indexed=&quot;true&quot; stored=&quot;true&quot; required=&quot;true&quot;/&gt;
    &lt;field name=&quot;chef&quot;        type=&quot;text_ja&quot; indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
    &lt;field name=&quot;recipe_name&quot; type=&quot;text_ja&quot; indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
    &lt;field name=&quot;genre&quot;       type=&quot;text_ja&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot;/&gt;
    &lt;field name=&quot;price&quot;       type=&quot;int&quot;     indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
    &lt;field name=&quot;_version_&quot;   type=&quot;long&quot;    indexed=&quot;true&quot; stored=&quot;true&quot;/&gt;
  &lt;/fields&gt;</code></pre>
</div>

<h3 id="section-3">フィールドタイプについて</h3>
<ul>
  <li>fieldType は自分で xml を用いて定義することができる</li>
  <li>それらの名前付けとかには習慣がある</li>
  <li>基本的な型については定義されているので、それを利用する</li>
</ul>

<h3 id="section-4">フィールドについて</h3>

<h4 id="section-5">テキストフィールドの定義</h4>
<ul>
  <li>name は filed 名</li>
  <li>type は filedType</li>
  <li>indexed は、 このフィールドを検索対象、ソート対象、 ファセット対象にするか(true:する)</li>
  <li>stored は、 このフィールドの値をそのまま index するか(true:する)</li>
  <li>required は、 必須かどうか</li>
  <li>multivalued は、 複数値を持てるかどうか</li>
  <li>omitNorms は、 検索したドキュメントの長さによる重み付け
    <ul>
      <li>(短ければ当然、見つけるものに近いのでポイントが高く、逆に長ければ、それにヒットする確率が高いので値は低い。)</li>
    </ul>
  </li>
</ul>

<h4 id="section-6">ダイナミックフィールド</h4>
<ul>
  <li>動的にフィールド名が決定するもの</li>
  <li>schema.xml を変更しなくても、そのフィールド名を登録したり検索したりすることができるようになる</li>
</ul>

<h4 id="section-7">ユニークキーフィールド</h4>
<ul>
  <li>文書内で unique に特定できるようにするフィールド</li>
  <li>差分更新したい場合には必須</li>
  <li>指定はオプション</li>
  <li>
    <uniquekey>url</uniquekey>
  </li>
</ul>

<h4 id="section-8">コピーフィールド</h4>
<ul>
  <li>ドキュメントへのインデックス登録時に copyField の source から dest へコピーする</li>
  <li>dest に同じものを複数指定する場合は multiValued が true である必要がある</li>
</ul>

<h3 id="core-admin--core-">core admin で core を作成</h3>
<p>collection1 をコピーして, schema.xml を編集。<br />
elevate が評価されてダメっぽかったのでコメントアウト。<br />
すると、うまく load できた。</p>

<h2 id="section-9">サンプルデータを入れてみよう</h2>
<p>だいたいこんなかんじの data.json を用意して</p>
<div>
  <pre><code class="json">[                                                                              
{                                                                              
    &quot;recipe_id&quot;:&quot;1&quot;,                                                           
    &quot;chef&quot;:&quot;vimtaku&quot;,                                                          
    &quot;recipe_name&quot;:&quot;vim の炒めもの&quot;,                                            
    &quot;genre&quot;:[&quot;和食&quot;, &quot;洋食&quot;],                                                  
    &quot;price&quot;:980                                                                
},                                                                             
{                                                                              
    &quot;recipe_id&quot;:&quot;2&quot;,                                                           
    &quot;chef&quot;:&quot;noro&quot;,                                                             
    &quot;recipe_name&quot;:&quot;emacs 焼き&quot;,                                                
    &quot;genre&quot;:[&quot;和食&quot;, &quot;中華&quot;],                                                  
    &quot;price&quot;:500                                                                
},                                                                             
{                                                                              
    &quot;recipe_id&quot;:&quot;3&quot;,                                                           
    &quot;chef&quot;:&quot;sublime&quot;,                                                          
    &quot;recipe_name&quot;:&quot;sublime 揚げ&quot;,                                              
    &quot;genre&quot;:[&quot;洋食&quot;],                                                          
    &quot;price&quot;:250                                                                
}                                                                              
]</code></pre>
</div>

<div>
  <pre><code class="bash">curl &#39;http://localhost:8983/solr/vimtaku/update/json?commit=true&#39; --data-binary @data.json -H &#39;Content-type:application/json;charset:utf-8&#39;</code></pre>
</div>

<p>これで データ登録が完了する。  </p>

<h2 id="dihdataimporthandler-">DIH(DataImportHandler) について</h2>
<p>DIH は DataSource, EntityProccssor, そして設定ファイル(data‐config.xml) から成る。<br />
DIH を使うための設定は、 solrconfig.xml と DIHの設定ファイル data―config にある。  </p>

<h3 id="solr-config-">solr config に記述する</h3>
<div>
  <pre><code class="xml">&lt;requestHandler name=&quot;/dataimport&quot; class=&quot;org.apache.solr.handler.dataimport.DatalmportHandler&quot;&gt;
&lt;lst name=&quot;defaults&quot;&gt;
  &lt;str name=&quot;config&quot;&gt;db-data-config.xml&lt;/str&gt;
&lt;/lst&gt;
&lt;/requestHandler&gt;</code></pre>
</div>

<h3 id="mysql--connector-">mysql の connector をダウンロードして設置</h3>
<p>mysql-connector-java-5.1.29-bin.jar を <a href="http://dev.mysql.com/downloads/connector/j/">http://dev.mysql.com/downloads/connector/j/</a>から落としてきて
dist 以下に設置する。</p>

<h3 id="mysql--db-data-configxml-">mysql の設定, db-data-config.xml の設定など</h3>
<p>そしてだいたいこんなかんじに設置する。 mysql は localhost の 3306 番で動いているものとし、<br />
solrsample っていう database があるものとする。 password は hogehoge とする。  </p>

<div>
  <pre><code class="bash">diff --git a/conf/db-data-config.xml b/conf/db-data-config.xml
new file mode 100644
index 0000000..c758319
--- /dev/null
+++ b/conf/db-data-config.xml
@@ -0,0 +1,24 @@
+&lt;dataConfig&gt;
+    &lt;dataSource type=&quot;JdbcDataSource&quot; driver=&quot;com.mysql.jdbc.Driver&quot;
+        url=&quot;jdbc:mysql://localhost:3306/solrsample&quot;
+        user=&quot;vimtaku&quot; password=&quot;hogehoge&quot;/&gt;
+    &lt;document&gt;
+        &lt;entity name=&quot;recipe_mst&quot; pk=&quot;recipe_id&quot;
+            query=&quot;select * from recipe_mst&quot;
+            deltaImportQuery=&quot;SELECT * FROM recipe_mst WHERE recipe_id = ${dataimporter.delta.recipe_id}&quot;
+            deltaQuery=&quot;select recipe_id from recipe_mst WHERE updated_at &gt;= &#39;${dataimporter.last_index_time}&#39;&quot;&gt;
+            &lt;field column=&quot;recipe_id&quot; name=&quot;recipe_id&quot; /&gt;
+            &lt;field column=&quot;recipe_name&quot; name=&quot;recipe_name&quot; /&gt;
+            &lt;field column=&quot;price&quot; name=&quot;price&quot; /&gt;
+            &lt;entity name=&quot;recipe_genre_rel&quot;
+                query=&quot;select * from recipe_genre_rel where recipe_id = &#39;${recipe_mst.recipe_id}&#39;&quot;&gt;
+                &lt;entity name=&quot;genre_mst&quot; query=&quot;select * from genre_mst where genre_id = &#39;${recipe_genre_rel.genre_id}&#39;&quot;&gt;
+                    &lt;field column=&quot;name&quot; name=&quot;genre&quot; /&gt;
+                &lt;/entity&gt;
+            &lt;/entity&gt;
+            &lt;entity name=&quot;chef_mst&quot; query=&quot;select * from chef_mst where chef_id = &#39;${recipe_mst.chef_id}&#39;&quot;&gt;
+                &lt;field column=&quot;name&quot; name=&quot;chef&quot; /&gt;
+            &lt;/entity&gt;
+        &lt;/entity&gt;
+    &lt;/document&gt;
+&lt;/dataConfig&gt;
diff --git a/conf/solrconfig.xml b/conf/solrconfig.xml
index 00b7555..2d19133 100644
--- a/conf/solrconfig.xml
+++ b/conf/solrconfig.xml
@@ -84,6 +84,9 @@
   &lt;lib dir=&quot;../../../contrib/velocity/lib&quot; regex=&quot;.*\.jar&quot; /&gt;
   &lt;lib dir=&quot;../../../dist/&quot; regex=&quot;solr-velocity-\d.*\.jar&quot; /&gt;

+  &lt;lib dir=&quot;../../../dist/&quot; regex=&quot;solr-dataimporthandler-.*\.jar&quot; /&gt;
+  &lt;lib dir=&quot;../../../dist/&quot; regex=&quot;mysql.*\.jar&quot; /&gt;
+
   &lt;!-- an exact &#39;path&#39; can be used instead of a &#39;dir&#39; to specify a
        specific jar file.  This will cause a serious error to be logged
        if it can&#39;t be loaded.
@@ -1513,6 +1516,15 @@
   &lt;/requestHandler&gt;


+  &lt;requestHandler name=&quot;/dataimport&quot;
+      class=&quot;org.apache.solr.handler.dataimport.DataImportHandler&quot;&gt;
+      &lt;lst name=&quot;defaults&quot;&gt;
+          &lt;str name=&quot;config&quot;&gt;db-data-config.xml&lt;/str&gt;</code></pre>
</div>

<p>だいたいこんなかんじで、管理画面から /dataimport で full-import するといける。</p>

<h2 id="deltaquery-">deltaQuery について</h2>
<p>差分 update(delta-import) のとき、deltaQuery がまず、実行される。
deltaQuery は どんなに nest が深くても実行される(たぶん)。</p>

<h3 id="deltaquery--parentdeltaquery-">deltaQuery と parentDeltaQuery の関係</h3>
<ul>
  <li>deltaQuery で mysql のレコードがヒットした場合に、 parentDeltaQuery が呼び出される</li>
  <li>parentDeltaQuery では ${chef_mst.chef_id} のように、 deltaQuery でヒットしたものが使える</li>
  <li>parentDeltaQuery で、 pk の 値を select するようにしておく。</li>
  <li>pk のある entity に、
    <ul>
      <li>deltaImportQuery 属性がなくて query 属性がある場合には where pk = ‘’ としてクエリが実行され再登録される模様</li>
      <li>deltaImportQuery 属性がある場合にはそのクエリが実行される。</li>
    </ul>
  </li>
</ul>

<p>例えば</p>

<div>
  <pre><code class="xml">&lt;dataConfig&gt;
    &lt;dataSource type=&quot;JdbcDataSource&quot; driver=&quot;com.mysql.jdbc.Driver&quot;
        url=&quot;jdbc:mysql://localhost:3306/solrsample&quot;
        user=&quot;vimtaku&quot; password=&quot;hogehoge&quot;/&gt;
    &lt;document&gt;
        &lt;entity name=&quot;recipe_mst&quot; pk=&quot;recipe_id&quot;
            query=&quot;select * from recipe_mst&quot;
            deltaImportQuery=&quot;SELECT * FROM recipe_mst WHERE recipe_id = ${dataimporter.delta.recipe_id}&quot;
            deltaQuery=&quot;select recipe_id from recipe_mst WHERE updated_at &gt;= &#39;${dataimporter.last_index_time}&#39;&quot;
            &gt;
            &lt;field column=&quot;recipe_id&quot; name=&quot;recipe_id&quot; /&gt;
            &lt;field column=&quot;recipe_name&quot; name=&quot;recipe_name&quot; /&gt;
            &lt;field column=&quot;price&quot; name=&quot;price&quot; /&gt;
            &lt;entity name=&quot;recipe_genre_rel&quot;
                query=&quot;select * from recipe_genre_rel where recipe_id = &#39;${recipe_mst.recipe_id}&#39;&quot;&gt;
                &lt;entity name=&quot;genre_mst&quot; query=&quot;select * from genre_mst where genre_id = &#39;${recipe_genre_rel.genre_id}&#39;&quot;&gt;
                    &lt;field column=&quot;name&quot; name=&quot;genre&quot; /&gt;
                &lt;/entity&gt;
            &lt;/entity&gt;
            &lt;entity name=&quot;chef_mst&quot; pk=&quot;chef_id&quot;
                query=&quot;select * from chef_mst where chef_id = &#39;${recipe_mst.chef_id}&#39;&quot;
                deltaQuery=&quot;select chef_id from chef_mst where chef_id = 1&quot;
                parentDeltaQuery=&quot;select recipe_id from chef_mst where chef_id = ${chef_mst.chef_id} limit 1&quot;
                &gt;
                &lt;field column=&quot;name&quot; name=&quot;chef&quot; /&gt;
            &lt;/entity&gt;
        &lt;/entity&gt;
    &lt;/document&gt;
&lt;/dataConfig&gt;</code></pre>
</div>

<p>こうなっていた場合、<br />
deltaQuery=”select chef_id from chef_mst where chef_id = 1”<br />
これでヒットした chef_id を元に<br />
parentDeltaQuery=”select recipe_id from chef_mst where chef_id = ${chef_mst.chef_id} limit 1”<br />
が実行されて、<br />
deltaImportQuery=”SELECT * FROM recipe_mst WHERE recipe_id = ${dataimporter.delta.recipe_id}”<br />
これが実行される。  </p>

<h2 id="deletedpkquery-">(2014/5/12追記) deletedPkQuery について</h2>
<p>deltaImportQuery では、インデックスにのったデータの削除はされない。<br />
なので、データを削除する場合は deletedPkQuery を使用する。<br />
deletedPkQuery=”SELECT * FROM chef_mst WHERE status = 0”<br />
のようにしておけば status = 0 の chef が削除できる。  </p>

<h2 id="timezone-">(2014/5/12追記) Timezone の扱い</h2>
<p>Solr のクラスタを動かすマシンによると思うが、マシンの timezone が JST, mysql の timezone が UTC などの場合も<br />
普通にあると思う。なので<br />
CONVERT_TZ(‘${dataimporter.last_index_time}’, ‘Asia/Tokyo’, ‘GMT’)<br />
などとして変換してあげるといろいろ捗るかもしれない。  </p>

<h2 id="dih--javascript-">DIH の直前で Javascript でデータを加工する</h2>

<h3 id="updatehandler--updatechain">UpdateHandler と UpdateChain</h3>
<p>UpdateHandler と DIH の仕組みはこの図のようになっている。  </p>

<p><img src="http://gyazo.com/47cc999c6d1a7a31ed9c2bdd0080ce59.png" />
(改訂版 Apache Solr 入門より引用。)</p>

<p>DIH とは疎になっていて、 UpdateHandler はどの requestHandler でも使えるように見える。  </p>

<p>設定には<a href="https://github.com/vimtaku/solr_sample/commit/85c7439d239d55e3344cc20a32461536c3201eb8">この差分</a>
を参照。  </p>

<p>これを使えば、json のカラムからとった json を parse して multiValue なカラムに登録などができる。  </p>

<h3 id="section-10">なんかうまくいかない場合</h3>
<p>キャッシュされたデータを更新するとたまに更新されない。<br />
自分は一回 core を削除、 $SOLR_HOME の data ディレクトリを rm -rf している。<br />
もっといい、データ削除(もしくはいれかえ)の方法知っている人は教えて下さい。。  </p>

<h2 id="url">参考URL</h2>
<p><a href="http://ja.wikipedia.org/wiki/Lucene">http://ja.wikipedia.org/wiki/Lucene</a><br />
<a href="http://wiki.apache.org/solr/DataImportHandler">http://wiki.apache.org/solr/DataImportHandler</a><br />
<a href="http://ochien.seesaa.net/article/153191074.html">http://ochien.seesaa.net/article/153191074.html</a><br />
<a href="http://d.hatena.ne.jp/kudzu/20110513/1305313247">http://d.hatena.ne.jp/kudzu/20110513/1305313247</a><br />
<a href="http://d.hatena.ne.jp/bowez/20100405#p2">http://d.hatena.ne.jp/bowez/20100405#p2</a>  </p>

<p>_</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-13T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/solr/'>solr</a>


</div>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/02/10/docker-boot2docker-port-foward/">
		
			Docker_boot2docker_port_foward</a>
	</h2>
	<div class="entry-content">
		
<h2 id="os-x-108--docker">OS X 10.8 公式サポートで話題の Docker</h2>

<p><a href="http://qiita.com/kanekoa/items/cf3cabb23da69c609002">これ</a>をもとにとりあえず docker client を準備,<br />
docker server を建てた。  </p>

<h2 id="mac--localhost--telnet-11211--memcached-">mac の localhost に telnet 11211 したら memcached につながるようにしたい</h2>

<p><a href="https://www.docker.io/learn/dockerfile/level2/">https://www.docker.io/learn/dockerfile/level2/</a>
これをもとに Dockerfile を作った。 ここでは ubuntu を元にした vimtaku/memcached_1 とした。  </p>

<p>Dockefile</p>
<div>
  <pre><code class="bash"># Memcached
#
# VERSION       2.2

# use the ubuntu base image provided by dotCloud
FROM ubuntu

MAINTAINER Victor Coisne victor.coisne@dotcloud.com

# make sure the package repository is up to date
RUN echo &quot;deb http://archive.ubuntu.com/ubuntu precise main universe&quot; &gt; /etc/apt/sources.list
RUN apt-get update

# install memcached
RUN apt-get install -y memcached

# Launch memcached when launching the container
ENTRYPOINT [&quot;memcached&quot;]

# run memcached as the daemon user
USER daemon

# expose memcached port
EXPOSE 11211</code></pre>
</div>

<div>
  <pre><code class="bash">docker build -t vimtaku/memcached_1 - &lt; Dockerfile</code></pre>
</div>

<p>これでとりあえず memcached な image を作れる。  </p>

<div>
  <pre><code class="bash">docker run -p 11211:11211 vimtaku/memcached_1</code></pre>
</div>

<p>これで boot2docker -&gt; ubuntu が立つ。  </p>

<h2 id="section">追記(2014/02/13)</h2>
<p>成功法っぽいのを発見した。<br />
恥ずかしながら ssh port fowarding が -L オプションで できるっていうのを
<a href="http://motemen.hatenablog.com/entry/2014/02/11/Dockerfile_%E3%82%92%E5%85%83%E3%81%AB%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%82%92%E8%B5%B0%E3%82%89%E3%81%9B%E3%81%A6%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E3%81%AB%E3%83%9D%E3%83%BC%E3%83%88%E3%82%92">このブログ記事</a>
で初めて知った。  </p>

<p>まだ、やってないけど  </p>
<div>
  <pre><code class="bash">ssh -L 11211:localhost:11211 -p 2022 root@localhost</code></pre>
</div>

<p>とかすれば、 ssh port fowarding できるので、以下の手順は不要。</p>

<p>追記終わり。</p>

<h2 id="section-1">とりあえず確認するには</h2>

<p>とりあえず確認するには<br />
boot2docker ssh して ifconfig | grep -A4 docker0 すると<br />
172…. のような IP が見える。<br />
そこに対して telnet すると ちゃんと疎通できてる。<br />
ちなみに telnet localhost 11211 しても同様。  </p>

<p>あとは mac -&gt; boot2docker に 11211 疎通できればよい。<br />
ぐぐったら
<a href="http://fogstack.wordpress.com/2014/02/09/docker-on-osx-port-forwarding/">http://fogstack.wordpress.com/2014/02/09/docker-on-osx-port-forwarding/</a> の記事が見つかったのでほぼこれの通りに、</p>

<div>
  <pre><code class="bash">boot2docker down
したあと
VBoxManage modifyvm &quot;boot2docker-vm&quot; --natpf1 &quot;guestmemcached,tcp,,11211,,11211&quot;
boot2docker up
docker run -d -p 11211:11211 vimtaku/memcached_1</code></pre>
</div>

<p>これで mac から telnet localhost 11211 で行けた。たぶん。</p>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-02-10T00:00:00+09:00" pubdate data-updated="true"></time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/docker/'>docker</a>


</div>
	
</div>
</article>

<nav id="pagenavi">
    
        <a href="/blog/page/3/" class="prev">Prev</a>
    
    
        <a href="/blog/page/5/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    vimtaku

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-30103097-2']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>